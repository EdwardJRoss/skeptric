<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>skeptric – reading_parquet_metadata</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">skeptric</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/EdwardJRoss"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="reading-parquet-metadata" class="level1">
<h1>Reading Parquet Metadata</h1>
<p><a href="https://parquet.apache.org/">Apache Parquet</a> is a common output format for distributed data pipelines, for example Spark and Presto. The files contain a lot of metadata about the contents of the file which can be useful to understand the data before querying it.</p>
<p>In our usecase we’re going to get metadata from the <a href="https://commoncrawl.org/2018/03/index-to-warc-files-and-urls-in-columnar-format/">Common Crawl Columnar Index</a> to help find which Parquet files contain an index to specific URLs.</p>
<section id="using-pyarrow-dataset" class="level2">
<h2 class="anchored" data-anchor-id="using-pyarrow-dataset">Using <a href="https://arrow.apache.org/docs/python/dataset.html">pyarrow dataset</a></h2>
<p>Pyarrow provides excellent support for Parquet and makes it easy to read the metadata.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow.dataset <span class="im">as</span> ds</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyarrow <span class="im">as</span> pa</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It only takes 16s to find all the partition data. (Note that you will need an Amazon Web Services account configured to run this because <a href="https://commoncrawl.org/2022/03/introducing-cloudfront-access-to-common-crawl-data/">it requires authentication</a>).</p>
<div class="cell" data-scrolled="true" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>cc_index_s3_path <span class="op">=</span> <span class="st">'s3://commoncrawl/cc-index/table/cc-main/warc/'</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>cc_index <span class="op">=</span> ds.dataset(cc_index_s3_path, <span class="bu">format</span><span class="op">=</span><span class="st">'parquet'</span>, partitioning<span class="op">=</span><span class="st">'hive'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 3.14 s, sys: 512 ms, total: 3.65 s
Wall time: 16.9 s</code></pre>
</div>
</div>
<p>We can access individual files.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>cc_index.files[<span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>'commoncrawl/cc-index/table/cc-main/warc/crawl=CC-MAIN-2022-05/subset=warc/part-00299-1e2959d8-5649-433a-b76e-f1b876a6479d.c000.gz.parquet'</code></pre>
</div>
</div>
<p>There’s also the <code>get_fragments</code> interface which returns pointers to the original files, but has additional methods and can be filtered.</p>
<p>For example we can list all the WARC files.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>fragments <span class="op">=</span> <span class="bu">list</span>(cc_index.get_fragments(<span class="bu">filter</span><span class="op">=</span>ds.field(<span class="st">'subset'</span>) <span class="op">==</span> <span class="st">'warc'</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>n_warc <span class="op">=</span> <span class="bu">len</span>(fragments)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>n_warc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 138 ms, sys: 3.61 ms, total: 142 ms
Wall time: 145 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>25193</code></pre>
</div>
</div>
<p>Here we just get the fragments for the WARC data from the 2022-05 crawl; which is 300 Parquet files.</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fragments <span class="op">=</span> <span class="bu">list</span>(cc_index.get_fragments(<span class="bu">filter</span><span class="op">=</span>(ds.field(<span class="st">'crawl'</span>) <span class="op">==</span> <span class="st">'CC-MAIN-2022-05'</span>) <span class="op">&amp;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                                        (ds.field(<span class="st">'subset'</span>) <span class="op">==</span> <span class="st">'warc'</span>)))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(fragments)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 7.51 ms, sys: 716 µs, total: 8.23 ms
Wall time: 8.22 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre><code>300</code></pre>
</div>
</div>
<p>Each fragment consists of an individual parquet file.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fragments[<span class="dv">0</span>].path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>'commoncrawl/cc-index/table/cc-main/warc/crawl=CC-MAIN-2022-05/subset=warc/part-00000-1e2959d8-5649-433a-b76e-f1b876a6479d.c000.gz.parquet'</code></pre>
</div>
</div>
<p>A Parquet file is split into row groups.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>fragments[<span class="dv">0</span>].row_groups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>[RowGroupInfo(0),
 RowGroupInfo(1),
 RowGroupInfo(2),
 RowGroupInfo(3),
 RowGroupInfo(4),
 RowGroupInfo(5),
 RowGroupInfo(6),
 RowGroupInfo(7),
 RowGroupInfo(8),
 RowGroupInfo(9),
 RowGroupInfo(10)]</code></pre>
</div>
</div>
<p>These row groups contain some statistics. In particular it’s approximately sorted by <code>url_surtkey</code>; if we are looking for a particular URL we can exclude row groups where the URL isn’t between the <code>min</code> and <code>max</code> values.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fragments[<span class="dv">0</span>].row_groups[<span class="dv">0</span>].statistics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>{'url_surtkey': {'min': 'com,wordpress,freefall852)/2016/03/29/billy-guy',
  'max': 'com,worldpackers)/search/skill_hospitality_entertainment/type_hotel?location_categories[]=nature&amp;location_types[]=hotel&amp;min_meals_count[]=3&amp;months[]=11&amp;skills[]=music'},
 'url': {'min': 'http://03.worldchefsbible.com/',
  'max': 'https://zh.worldallianceofdramatherapy.com/he-mission'},
 'url_host_name': {'min': '03.worldchefsbible.com',
  'max': 'zr1.worldblast.com'},
 'url_host_tld': {'min': 'com', 'max': 'com'},
 'url_host_2nd_last_part': {'min': 'wordpress', 'max': 'worldpackers'},
 'url_host_3rd_last_part': {'min': '03', 'max': 'zr1'},
 'url_host_4th_last_part': {'min': 'bbbfoundation', 'max': 'www'},
 'url_host_5th_last_part': {'min': 'http', 'max': 'toolbox'},
 'url_host_registry_suffix': {'min': 'com', 'max': 'com'},
 'url_host_registered_domain': {'min': 'wordpress.com',
  'max': 'worldpackers.com'},
 'url_host_private_suffix': {'min': 'com', 'max': 'com'},
 'url_host_private_domain': {'min': 'wordpress.com',
  'max': 'worldpackers.com'},
 'url_host_name_reversed': {'min': 'com.wordpress.freefall852',
  'max': 'com.worldpackers.www'},
 'url_protocol': {'min': 'http', 'max': 'https'},
 'url_port': {'min': 443, 'max': 2000},
 'url_path': {'min': '',
  'max': '/▶-if-i-unblock-someone-on-whatsapp-will-they-find-out/'},
 'url_query': {'min': '', 'max': 'zh-cn'},
 'fetch_time': {'min': datetime.datetime(2022, 1, 16, 9, 32, 20, tzinfo=&lt;UTC&gt;),
  'max': datetime.datetime(2022, 1, 29, 15, 10, 45, tzinfo=&lt;UTC&gt;)},
 'fetch_status': {'min': 200, 'max': 200},
 'content_digest': {'min': '2223CG5SRUGFII5CRWMUD2766UWOL7MU',
  'max': 'ZZZZKJBCLHGPU4P2LIHR3X4PZOZSJ4SV'},
 'content_mime_type': {'min': 'Application/Unknown', 'max': 'video/x-ms-asf'},
 'content_mime_detected': {'min': 'application/atom+xml',
  'max': 'video/x-ms-asf'},
 'content_charset': {'min': 'Big5', 'max': 'x-windows-949'},
 'content_languages': {'min': 'afr', 'max': 'zho,xho,eng'},
 'content_truncated': {'min': 'disconnect', 'max': 'length'},
 'warc_filename': {'min': 'crawl-data/CC-MAIN-2022-05/segments/1642320299852.23/warc/CC-MAIN-20220116093137-20220116123137-00000.warc.gz',
  'max': 'crawl-data/CC-MAIN-2022-05/segments/1642320306346.64/warc/CC-MAIN-20220128212503-20220129002503-00719.warc.gz'},
 'warc_record_offset': {'min': 932, 'max': 1202361748},
 'warc_record_length': {'min': 489, 'max': 1049774},
 'warc_segment': {'min': '1642320299852.23', 'max': '1642320306346.64'}}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fragments[<span class="dv">0</span>].row_groups[<span class="dv">0</span>].<span class="bu">id</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fragments[<span class="dv">0</span>].row_groups[<span class="dv">0</span>].num_rows</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>1730100</code></pre>
</div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">25_000</span> <span class="op">/</span><span class="dv">3</span>) <span class="op">/</span> <span class="dv">60</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>138.88888888888889</code></pre>
</div>
</div>
<p>We can go ahead an iterate through all the fragments and extract the row-group data.</p>
<p>Around 2-3/second.</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> time</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>row_group_statistics <span class="op">=</span> []</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, f <span class="kw">in</span> tqdm(<span class="bu">enumerate</span>(fragments), total<span class="op">=</span><span class="bu">len</span>(fragments)):</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row_group <span class="kw">in</span> f.row_groups:</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        row_group_statistics.append(</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'bucket'</span>: f.path.split(<span class="st">'/'</span>, maxsplit<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>],</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">'key'</span>: f.path.split(<span class="st">'/'</span>, maxsplit<span class="op">=</span><span class="dv">1</span>)[<span class="dv">1</span>],</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'id'</span>: row_group.<span class="bu">id</span>,</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'num_rows'</span>: row_group.num_rows,</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'min_url_surtkey'</span>: row_group.statistics[<span class="st">'url_surtkey'</span>][<span class="st">'min'</span>],</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'max_url_surtkey'</span>: row_group.statistics[<span class="st">'url_surtkey'</span>][<span class="st">'min'</span>],</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">&gt;=</span> N:</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>elapsed_time <span class="op">=</span> time() <span class="op">-</span> start_time</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>elapsed_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"65ef355cff95484c900189a24ca6e5a4","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>7.918716907501221</code></pre>
</div>
</div>
<p>Processing all the files would take around this many minutes:</p>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(elapsed_time <span class="op">*</span> n_warc <span class="op">/</span> N) <span class="op">/</span> <span class="dv">60</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>166.2468625422319</code></pre>
</div>
</div>
<p>It seems to take an unusually long time to read the row_group statistics.</p>
</section>
<section id="using-fastparquet" class="level2">
<h2 class="anchored" data-anchor-id="using-fastparquet">Using fastparquet</h2>
<p><a href="https://github.com/dask/fastparquet/">Fastparquet</a> is another system to read Parquet files creates by the <a href="https://dask.org/">Dask Project</a>.</p>
<p>For remote files we need to pass the fsspec filesystem; in this case using s3fs.</p>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastparquet <span class="im">import</span> ParquetFile</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> s3fs</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>fs <span class="op">=</span> s3fs.S3FileSystem()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s quite slow and takes seconds to even access a single file (this just reads the metadata, no data is loaded). It seems like we can pass the whole <code>cc_index_s3_path</code>, but it would take prohibitively long to process. Perhaps this would be better if the compute was located closer to the data (this is being run on a laptop in Australia).</p>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>pf <span class="op">=</span> ParquetFile(fn<span class="op">=</span>fragments[<span class="dv">0</span>].path, fs<span class="op">=</span>fs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 176 ms, sys: 56.6 ms, total: 232 ms
Wall time: 2.33 s</code></pre>
</div>
</div>
<p>We can access all the statistics through the <code>fmd</code> attribue (file meta data).</p>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>pf.fmd.row_groups[<span class="dv">0</span>].columns[<span class="dv">0</span>].meta_data._asdict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>{'type': 6,
 'encodings': [0, 4],
 'path_in_schema': ['url_surtkey'],
 'codec': 2,
 'num_values': 1730100,
 'total_uncompressed_size': 117917394,
 'total_compressed_size': 23113472,
 'key_value_metadata': None,
 'data_page_offset': 4,
 'index_page_offset': None,
 'dictionary_page_offset': None,
 'statistics': {'max': None,
  'min': None,
  'null_count': 0,
  'distinct_count': None,
  'max_value': "b'com,worldpackers)/search/skill_hospitality_entertainment/type_hotel?location_categories[]=nature&amp;location_types[]=hotel&amp;min_meals_count[]=3&amp;months[]=11&amp;skills[]=music'",
  'min_value': "b'com,wordpress,freefall852)/2016/03/29/billy-guy'"},
 'encoding_stats': [{'page_type': 0, 'encoding': 0, 'count': 122}],
 'bloom_filter_offset': None}</code></pre>
</div>
</div>
</section>
</section>
<section id="directly-reading-parquet-metadata" class="level1">
<h1>Directly reading Parquet metadata</h1>
<p>Apache Arrow datasets and fastparquet are convenient, but they are slow. Let’s see what it takes to read Parquet metadata.</p>
<p>Looking at the Apache Parquet <a href="https://parquet.apache.org/docs/file-format/">file format</a> the file metadata is at the end of the file, followed by a 4 byte integer describing the metadata length and then 4 bytes with the magic number “PAR1”.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="reading_parquet_metadata_files/figure-html/image.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>S3 has a HTTP REST interface; while we could use it directly we will access it through boto to abstract away things like authentication.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>s3 <span class="op">=</span> boto3.client(<span class="st">'s3'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start with a single parquet file</p>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> fragments[<span class="dv">0</span>].path</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">file</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>'commoncrawl/cc-index/table/cc-main/warc/crawl=CC-MAIN-2022-05/subset=warc/part-00000-1e2959d8-5649-433a-b76e-f1b876a6479d.c000.gz.parquet'</code></pre>
</div>
</div>
<p>For Boto we need to separate out the bucket (commoncrawl), from the key (the rest)</p>
<div class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>bucket, key <span class="op">=</span> <span class="bu">file</span>.split(<span class="st">'/'</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="getting-the-file-metadata" class="level2">
<h2 class="anchored" data-anchor-id="getting-the-file-metadata">Getting the file metadata</h2>
<p>Reading in the whole file is going to be slow, so we need to work out where the end of the file is; that is we need to know the file’s length. For a start we’re going to need a way of working out where the end of the file is; that is it’s length.</p>
<p>We can use a HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/HEAD">HEAD</a> request, which should return the <a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.13">Content-Length</a>; the size of the file in bytes (8 bits).</p>
<div class="cell" data-scrolled="true" data-execution_count="20">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time metadata <span class="op">=</span> s3.head_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 27.4 ms, sys: 7.98 ms, total: 35.4 ms
Wall time: 1.01 s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>metadata</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>{'ResponseMetadata': {'RequestId': '6AWKV1DJNRTEER3W',
  'HostId': 'YtP3flNoav+Ht8NgTRWGNrbeXXvkPbpH2+C1Xo8m2gcD4e9gbZQBazEVnozbS0qEdMXZg4XvQ1g=',
  'HTTPStatusCode': 200,
  'HTTPHeaders': {'x-amz-id-2': 'YtP3flNoav+Ht8NgTRWGNrbeXXvkPbpH2+C1Xo8m2gcD4e9gbZQBazEVnozbS0qEdMXZg4XvQ1g=',
   'x-amz-request-id': '6AWKV1DJNRTEER3W',
   'date': 'Mon, 18 Apr 2022 12:23:58 GMT',
   'last-modified': 'Sun, 30 Jan 2022 05:01:16 GMT',
   'etag': '"45ca767a5b7c8226dd75be1b8bb525f0"',
   'x-amz-storage-class': 'INTELLIGENT_TIERING',
   'accept-ranges': 'bytes',
   'content-type': 'application/octet-stream',
   'server': 'AmazonS3',
   'content-length': '1344281529'},
  'RetryAttempts': 0},
 'AcceptRanges': 'bytes',
 'LastModified': datetime.datetime(2022, 1, 30, 5, 1, 16, tzinfo=tzutc()),
 'ContentLength': 1344281529,
 'ETag': '"45ca767a5b7c8226dd75be1b8bb525f0"',
 'ContentType': 'application/octet-stream',
 'Metadata': {},
 'StorageClass': 'INTELLIGENT_TIERING'}</code></pre>
</div>
</div>
<p>The whole file is quite large to read in at once, and there are 300 of them!</p>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>content_length <span class="op">=</span> <span class="bu">int</span>(metadata[<span class="st">'ContentLength'</span>])</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="ss">f'</span><span class="sc">{</span>content_length <span class="op">/</span> (<span class="dv">1024</span><span class="op">**</span><span class="dv">3</span>)<span class="sc">:0.1f}</span><span class="ss"> GB'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>'1.3 GB'</code></pre>
</div>
</div>
<p>We can just read in the last 8 bytes by passing Range to get_object, which under the hood is using a HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests">Range Requst</a>.</p>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>end_byte <span class="op">=</span> content_length</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>start_byte <span class="op">=</span> end_byte <span class="op">-</span> <span class="dv">8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> s3.get_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key, Range<span class="op">=</span><span class="ss">f'bytes=</span><span class="sc">{</span>start_byte<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>end_byte<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>end_content <span class="op">=</span> response[<span class="st">'Body'</span>].read()</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>end_content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 11.3 ms, sys: 0 ns, total: 11.3 ms
Wall time: 258 ms</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>b'o\xe5\x00\x00PAR1'</code></pre>
</div>
</div>
<p>The end is the magic number for the Parquet format.</p>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> end_content[<span class="op">-</span><span class="dv">4</span>:] <span class="op">==</span> <span class="st">b'PAR1'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is preceeded by the length of the metadata in bytes.</p>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>file_meta_length <span class="op">=</span> <span class="bu">int</span>.from_bytes(end_content[:<span class="dv">4</span>], byteorder<span class="op">=</span><span class="st">'little'</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ss">f'</span><span class="sc">{</span>file_meta_length <span class="op">/</span> <span class="dv">1024</span><span class="sc">:0.1f}</span><span class="ss"> kb'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>'57.4 kb'</code></pre>
</div>
</div>
<p>Now we know how long the metadata is we can read it from the file.</p>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>end_byte <span class="op">=</span> content_length <span class="op">-</span> <span class="dv">8</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>start_byte <span class="op">=</span> content_length <span class="op">-</span> <span class="dv">8</span> <span class="op">-</span> file_meta_length</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note this takes just a little longer than reading 2 bytes; there’s a relatively high constant overhead per request.</p>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> s3.get_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key, Range<span class="op">=</span><span class="ss">f'bytes=</span><span class="sc">{</span>start_byte<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>end_byte<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>file_meta_content <span class="op">=</span> response[<span class="st">'Body'</span>].read()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 5.33 ms, sys: 4.37 ms, total: 9.7 ms
Wall time: 496 ms</code></pre>
</div>
</div>
</section>
<section id="decoding-file-metadata" class="level2">
<h2 class="anchored" data-anchor-id="decoding-file-metadata">Decoding file metadata</h2>
<p>The Apache Parquet <a href="https://parquet.apache.org/docs/file-format/metadata/">metadata documentation</a> shows the format of the file metadata, which we can parse.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="reading_parquet_metadata_files/figure-html/image.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">image.png</figcaption><p></p>
</figure>
</div>
<p>This is pretty involved, so I’ll cheat and use the good work of fastparquet to read the metadata for me.</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastparquet.cencoding <span class="im">import</span> from_buffer</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>fmd <span class="op">=</span> from_buffer(file_meta_content, <span class="st">"FileMetaData"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s using <a href="https://thrift.apache.org/">Apache Thrift</a> for the file metadata.</p>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(fmd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>fastparquet.cencoding.ThriftObject</code></pre>
</div>
</div>
<p>We can then extract these fields as attributes; like the version</p>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(fmd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>['column_orders',
 'created_by',
 'encryption_algorithm',
 'footer_signing_key_metadata',
 'key_value_metadata',
 'num_rows',
 'row_groups',
 'schema',
 'version']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>fmd.version</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>1</code></pre>
</div>
</div>
<p>Or the schema</p>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>fmd.schema[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>{'type': None, 'type_length': None, 'repetition_type': None, 'name': "b'spark_schema'", 'num_children': 30, 'converted_type': None, 'scale': None, 'precision': None, 'field_id': None, 'logicalType': None}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>fmd.schema[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>{'type': 6, 'type_length': None, 'repetition_type': 0, 'name': "b'url_surtkey'", 'num_children': None, 'converted_type': 0, 'scale': None, 'precision': None, 'field_id': None, 'logicalType': {'STRING': {}, 'MAP': None, 'LIST': None, 'ENUM': None, 'DECIMAL': None, 'DATE': None, 'TIME': None, 'TIMESTAMP': None, 'INTEGER': None, 'UNKNOWN': None, 'JSON': None, 'BSON': None, 'UUID': None}}</code></pre>
</div>
</div>
<p>And the row groups</p>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fmd.row_groups[<span class="dv">0</span>].total_byte_size</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>452304596</code></pre>
</div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>fmd.row_groups[<span class="dv">0</span>].columns[<span class="dv">0</span>].meta_data._asdict()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>{'type': 6,
 'encodings': [0, 4],
 'path_in_schema': ['url_surtkey'],
 'codec': 2,
 'num_values': 1730100,
 'total_uncompressed_size': 117917394,
 'total_compressed_size': 23113472,
 'key_value_metadata': None,
 'data_page_offset': 4,
 'index_page_offset': None,
 'dictionary_page_offset': None,
 'statistics': {'max': None,
  'min': None,
  'null_count': 0,
  'distinct_count': None,
  'max_value': "b'com,worldpackers)/search/skill_hospitality_entertainment/type_hotel?location_categories[]=nature&amp;location_types[]=hotel&amp;min_meals_count[]=3&amp;months[]=11&amp;skills[]=music'",
  'min_value': "b'com,wordpress,freefall852)/2016/03/29/billy-guy'"},
 'encoding_stats': [{'page_type': 0, 'encoding': 0, 'count': 122}],
 'bloom_filter_offset': None}</code></pre>
</div>
</div>
<p>And the location of each column</p>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>fmd.row_groups[<span class="dv">1</span>].columns[<span class="dv">0</span>].file_offset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>134217728</code></pre>
</div>
</div>
</section>
<section id="putting-it-together" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-together">Putting it together</h2>
<p>We can combine all of this into a single function.</p>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parquet_metadata_s3(path, s3):</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    metadata <span class="op">=</span> s3.head_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    content_length <span class="op">=</span> <span class="bu">int</span>(metadata[<span class="st">'ContentLength'</span>])</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    end_response <span class="op">=</span> s3.get_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key, Range<span class="op">=</span><span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    end_content <span class="op">=</span> end_response[<span class="st">'Body'</span>].read()</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> end_content[<span class="op">-</span><span class="dv">4</span>:] <span class="op">!=</span> <span class="st">b'PAR1'</span>:</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">'File at </span><span class="sc">%s</span><span class="st"> does not look like a Parquet file; magic </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (path, end_content[<span class="op">-</span><span class="dv">4</span>:]))</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    file_meta_length <span class="op">=</span> <span class="bu">int</span>.from_bytes(end_content[:<span class="dv">4</span>], byteorder<span class="op">=</span><span class="st">'little'</span>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>    file_meta_response <span class="op">=</span> s3.get_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key,</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>                                       Range<span class="op">=</span><span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="op">-</span>file_meta_length<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    file_meta_content <span class="op">=</span> file_meta_response[<span class="st">'Body'</span>].read()</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    fmd <span class="op">=</span> from_buffer(file_meta_content, <span class="st">"FileMetaData"</span>)</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fmd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is quicker than fastparquet (although perhaps doing less), and a little faster than pyarrow.</p>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time fmd <span class="op">=</span> parquet_metadata_s3(<span class="bu">file</span>, s3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 22 ms, sys: 258 µs, total: 22.2 ms
Wall time: 1.02 s</code></pre>
</div>
</div>
</section>
<section id="using-http" class="level2">
<h2 class="anchored" data-anchor-id="using-http">Using HTTP</h2>
<p>Common Crawl also exposes a <a href="https://commoncrawl.org/2022/03/introducing-cloudfront-access-to-common-crawl-data/">HTTP Interface</a> to the S3 buckets hosted using AWS CloudFront. We can try to access those instead.</p>
<section id="using-pyarrow" class="level3">
<h3 class="anchored" data-anchor-id="using-pyarrow">Using Pyarrow</h3>
<p>Pyarrow can read the files from anything that supports fsspec, and so we can pass a HTTPFileSystem.</p>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fsspec.implementations.http <span class="im">import</span> HTTPFileSystem</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>http <span class="op">=</span> HTTPFileSystem()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However it can’t discover the partitions and files because there is no way to list them over HTTP; only the individual files can be accessed. We can manually pass the files however.</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>http_files <span class="op">=</span> [<span class="st">'https://data.commoncrawl.org/'</span> <span class="op">+</span> x.split(<span class="st">'/'</span>, <span class="dv">1</span>)[<span class="dv">1</span>] <span class="cf">for</span> x <span class="kw">in</span> cc_index.files]</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>http_files[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>'https://data.commoncrawl.org/cc-index/table/cc-main/warc/crawl=CC-MAIN-2013-20/subset=warc/part-00000-6ac52f25-05a1-4998-adf1-b8c830c08eec.c000.gz.parquet'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>cc_index_http <span class="op">=</span> ds.dataset(http_files, <span class="bu">format</span><span class="op">=</span><span class="st">'parquet'</span>, partitioning<span class="op">=</span><span class="st">'hive'</span>, filesystem<span class="op">=</span>http)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1.16 s, sys: 110 ms, total: 1.27 s
Wall time: 2.97 s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>fragments_http <span class="op">=</span> <span class="bu">list</span>(cc_index_http.get_fragments())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 296 ms, sys: 0 ns, total: 296 ms
Wall time: 294 ms</code></pre>
</div>
</div>
<p>This runs at a similar rate to S3.</p>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.auto <span class="im">import</span> tqdm</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> time <span class="im">import</span> time</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>N <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time()</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>row_group_statistics <span class="op">=</span> []</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, f <span class="kw">in</span> tqdm(<span class="bu">enumerate</span>(fragments_http), total<span class="op">=</span><span class="bu">len</span>(fragments_http)):</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row_group <span class="kw">in</span> f.row_groups:</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>        row_group_statistics.append(</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>            {<span class="st">'bucket'</span>: f.path.split(<span class="st">'/'</span>, maxsplit<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>],</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">'key'</span>: f.path.split(<span class="st">'/'</span>, maxsplit<span class="op">=</span><span class="dv">1</span>)[<span class="dv">1</span>],</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">'id'</span>: row_group.<span class="bu">id</span>,</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">'num_rows'</span>: row_group.num_rows,</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">'min_url_surtkey'</span>: row_group.statistics[<span class="st">'url_surtkey'</span>][<span class="st">'min'</span>],</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>             <span class="st">'max_url_surtkey'</span>: row_group.statistics[<span class="st">'url_surtkey'</span>][<span class="st">'min'</span>],</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> i <span class="op">&gt;=</span> N:</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>elapsed_time <span class="op">=</span> time() <span class="op">-</span> start_time</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>elapsed_time</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"5d3a415714a0425aa255615264c6db68","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>31.016972541809082</code></pre>
</div>
</div>
</section>
<section id="accessing-http-endpoint-directly" class="level3">
<h3 class="anchored" data-anchor-id="accessing-http-endpoint-directly">Accessing HTTP endpoint directly</h3>
<p>This is essentially the same as the S3 Boto version.</p>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parquet_metadata_http(url, session<span class="op">=</span>requests):</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    metadata <span class="op">=</span> session.head(url)</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>    metadata.raise_for_status()</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>    content_length <span class="op">=</span> <span class="bu">int</span>(metadata.headers[<span class="st">'Content-Length'</span>])</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>    end_response <span class="op">=</span> requests.get(url, headers<span class="op">=</span>{<span class="st">"Range"</span>: <span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    end_response.raise_for_status()</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    end_content <span class="op">=</span> end_response.content</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> end_content[<span class="op">-</span><span class="dv">4</span>:] <span class="op">!=</span> <span class="st">b'PAR1'</span>:</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">'File at </span><span class="sc">%s</span><span class="st"> does not look like a Parquet file; magic </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (path, end_content[<span class="op">-</span><span class="dv">4</span>:]))</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>    file_meta_length <span class="op">=</span> <span class="bu">int</span>.from_bytes(end_content[:<span class="dv">4</span>], byteorder<span class="op">=</span><span class="st">'little'</span>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    file_meta_response <span class="op">=</span> requests.get(url, headers<span class="op">=</span>{<span class="st">"Range"</span>: <span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="op">-</span>file_meta_length<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">'</span>})</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    file_meta_response.raise_for_status()</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    file_meta_content <span class="op">=</span> file_meta_response.content</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>    fmd <span class="op">=</span> from_buffer(file_meta_content, <span class="st">"FileMetaData"</span>)</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fmd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The result is a similar speed to the S3 version.</p>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time fmd <span class="op">=</span> parquet_metadata_http(http_files[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 91.9 ms, sys: 0 ns, total: 91.9 ms
Wall time: 1.59 s</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="speeding-up-with-asyncio" class="level1">
<h1>Speeding up with asyncio</h1>
<p>Most of the time is spent waiting for the remote server, and transferring data over the network. We want to do this for a very large number of files. This is a perfect use case for asyncio; instead of waiting for each request to complete before starting the next we can switch to running a new request while the first is waiting.</p>
<p>I’m still learning asyncio, and I mostly adapted this <a href="https://stackoverflow.com/questions/57126286/fastest-parallel-requests-in-python">from Stackoverflow</a>.</p>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aiohttp</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> _async_parquet_metadata_http(url, session):</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.head(url) <span class="im">as</span> response:</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> response.read()</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>        output_headers <span class="op">=</span> response.headers</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>        content_length <span class="op">=</span> <span class="bu">int</span>(output_headers[<span class="st">'Content-Length'</span>])</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{<span class="st">"Range"</span>: <span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.get(url<span class="op">=</span>url, headers<span class="op">=</span>headers) <span class="im">as</span> response:</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>        end_content <span class="op">=</span> <span class="cf">await</span> response.read()</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> end_content[<span class="op">-</span><span class="dv">4</span>:] <span class="op">!=</span> <span class="st">b'PAR1'</span>:</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">'File at </span><span class="sc">%s</span><span class="st"> does not look like a Parquet file; magic </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (path, end_content[<span class="op">-</span><span class="dv">4</span>:]))</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    file_meta_length <span class="op">=</span> <span class="bu">int</span>.from_bytes(end_content[:<span class="dv">4</span>], byteorder<span class="op">=</span><span class="st">'little'</span>)</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{<span class="st">"Range"</span>: <span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="op">-</span>file_meta_length<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.get(url, headers<span class="op">=</span>headers) <span class="im">as</span> response:</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>        file_meta_content <span class="op">=</span> <span class="cf">await</span> response.read()</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>    fmd <span class="op">=</span> from_buffer(file_meta_content, <span class="st">"FileMetaData"</span>)</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fmd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm.asyncio <span class="im">import</span> tqdm_asyncio</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> async_parquet_metadata_http(urls):</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> aiohttp.ClientSession(raise_for_status<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> session:</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> <span class="cf">await</span> tqdm_asyncio.gather(<span class="op">*</span>[_async_parquet_metadata_http(url, session) <span class="cf">for</span> url <span class="kw">in</span> urls])</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ret</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is orders of magnitude faster than running the requests sequentially.</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> <span class="cf">await</span>(async_parquet_metadata_http(http_files[:<span class="dv">200</span>]))</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Ran in </span><span class="sc">{</span>time<span class="sc">.</span>time() <span class="op">-</span> start_time<span class="sc">:0.1f}</span><span class="ss"> s'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████| 200/200 [00:05&lt;00:00, 37.98it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Ran in 5.3 s</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
<p>We can do a simlar thing with S3 using <code>aiobotocore</code>.</p>
<p>Again I don’t have my head around asyncio, so this may be a terrible implementation.</p>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> aiobotocore.session <span class="im">import</span> get_session</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> _async_parquet_metadata_s3(path, s3):</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    metadata <span class="op">=</span> <span class="cf">await</span> s3.head_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    content_length <span class="op">=</span> <span class="bu">int</span>(metadata[<span class="st">'ContentLength'</span>])</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>    end_response <span class="op">=</span> <span class="cf">await</span> s3.get_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key, Range<span class="op">=</span><span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    end_content <span class="op">=</span> <span class="cf">await</span> end_response[<span class="st">'Body'</span>].read()</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> end_content[<span class="op">-</span><span class="dv">4</span>:] <span class="op">!=</span> <span class="st">b'PAR1'</span>:</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">'File at </span><span class="sc">%s</span><span class="st"> does not look like a Parquet file; magic </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (path, end_content[<span class="op">-</span><span class="dv">4</span>:]))</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>    file_meta_length <span class="op">=</span> <span class="bu">int</span>.from_bytes(end_content[:<span class="dv">4</span>], byteorder<span class="op">=</span><span class="st">'little'</span>)</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>    file_meta_response <span class="op">=</span> <span class="cf">await</span> s3.get_object(Bucket<span class="op">=</span>bucket, Key<span class="op">=</span>key,</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>                                       Range<span class="op">=</span><span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="op">-</span>file_meta_length<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>    file_meta_content <span class="op">=</span> <span class="cf">await</span> file_meta_response[<span class="st">'Body'</span>].read()</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>    fmd <span class="op">=</span> from_buffer(file_meta_content, <span class="st">"FileMetaData"</span>)</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fmd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> async_parquet_metadata_s3(urls):</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    session <span class="op">=</span> get_session()</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.create_client(<span class="st">'s3'</span>) <span class="im">as</span> s3:</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> <span class="cf">await</span> tqdm_asyncio.gather(<span class="op">*</span>[_async_parquet_metadata_s3(url, s3) <span class="cf">for</span> url <span class="kw">in</span> urls])</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ret</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s quite a bit slower than HTTP. Since S3 has a REST API that boto3 uses I’d expect it to be a similar speed; it would be interesting to find out what is happening here.</p>
<p>But we can just stick to the HTTP interface.</p>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> <span class="cf">await</span>(async_parquet_metadata_s3(cc_index.files[:<span class="dv">200</span>]))</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Ran in </span><span class="sc">{</span>time<span class="sc">.</span>time() <span class="op">-</span> start_time<span class="sc">:0.1f}</span><span class="ss"> s'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████████████████████████████████| 200/200 [00:18&lt;00:00, 10.54it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Ran in 19.2 s</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="scaling-up" class="level1">
<h1>Scaling up</h1>
<p>What happens as we scale up to the whole index?</p>
<p>We are just interested in the WARC files, which there are a lot of.</p>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>warc_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> cc_index.files <span class="cf">if</span> <span class="st">'/subset=warc/'</span> <span class="kw">in</span> f]</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>num_files <span class="op">=</span> <span class="bu">len</span>(warc_files)</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>num_files</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>25193</code></pre>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>http_files <span class="op">=</span> [<span class="st">'https://data.commoncrawl.org/'</span> <span class="op">+</span> x.split(<span class="st">'/'</span>, <span class="dv">1</span>)[<span class="dv">1</span>] <span class="cf">for</span> x <span class="kw">in</span> warc_files]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The total length of all the content will be around:</p>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="ss">f'</span><span class="sc">{</span>(file_meta_length <span class="op">*</span> num_files) <span class="op">/</span> <span class="dv">1024</span><span class="op">**</span><span class="dv">3</span><span class="sc">:0.2f}</span><span class="ss"> GB'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre><code>'1.38 GB'</code></pre>
</div>
</div>
<p>We’re hitting around 50-60/s, with 3 requests per file giving a total of ~150-200 requests/second. CommonCrawl is geared towards exporting data, so this may be fine but the server may throttle us.</p>
<p>We’re also making ~75k+ requests. There’s a good chance something will go wrong.</p>
<p>I can think of 3 kinds of issues:</p>
<ol type="1">
<li>An intermittent issue causes an individual load to fail.</li>
<li>There is an issue with an individual file and so loading will always fail.</li>
<li>There is an environmental issue (server rejecting all requests, network down) and all requests fail.</li>
</ol>
<p>We also don’t want all 25k requests being handled simultaneously, the overhead of managing all the task switching will be too much.</p>
<p>A simple approach is:</p>
<ol type="1">
<li>Run a batch of N requests</li>
<li>Capture any errors and put these jobs in a retry cue (to handle 1)</li>
<li>Remove any jobs that have been retried too many times (to handle 2)</li>
<li>If more than x% of the N requests fail abort the process (to handle 3).</li>
</ol>
<p>Since the data is immutable we can persist the data to disk and resume. One simple solution is <a href="https://github.com/RaRe-Technologies/sqlitedict">sqlitedict</a>. It makes sense to fetch the data as one step, and then extract the data afterwards (since it’s harder to recover from an error in extraction).</p>
<p>Let’s catch common exceptions and raise them</p>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> aiohttp</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Union</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> _async_parquet_metadata_http(url, session):</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Retrieve Parquet file metadata from url using session"""</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.head(url) <span class="im">as</span> response:</span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> response.read()</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>        output_headers <span class="op">=</span> response.headers</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>        content_length <span class="op">=</span> <span class="bu">int</span>(output_headers[<span class="st">'Content-Length'</span>])</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{<span class="st">"Range"</span>: <span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.get(url<span class="op">=</span>url, headers<span class="op">=</span>headers) <span class="im">as</span> response:</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>        end_content <span class="op">=</span> <span class="cf">await</span> response.read()</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> end_content[<span class="op">-</span><span class="dv">4</span>:] <span class="op">!=</span> <span class="st">b'PAR1'</span>:</span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">'File at </span><span class="sc">%s</span><span class="st"> does not look like a Parquet file; magic </span><span class="sc">%s</span><span class="st">'</span> <span class="op">%</span> (path, end_content[<span class="op">-</span><span class="dv">4</span>:]))</span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a>    file_meta_length <span class="op">=</span> <span class="bu">int</span>.from_bytes(end_content[:<span class="dv">4</span>], byteorder<span class="op">=</span><span class="st">'little'</span>)</span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    headers<span class="op">=</span>{<span class="st">"Range"</span>: <span class="ss">f'bytes=</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="op">-</span>file_meta_length<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>content_length<span class="op">-</span><span class="dv">8</span><span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> session.get(url, headers<span class="op">=</span>headers) <span class="im">as</span> response:</span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>        file_meta_content <span class="op">=</span> <span class="cf">await</span> response.read()</span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> file_meta_content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> fetch_parquet_metadata_http(urls):</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">async</span> <span class="cf">with</span> aiohttp.ClientSession(raise_for_status<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> session:</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>        ret <span class="op">=</span> <span class="cf">await</span> asyncio.gather(<span class="op">*</span>[_async_parquet_metadata_http(url, session) <span class="cf">for</span> url <span class="kw">in</span> urls], return_exceptions<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ret</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s open a fresh sqlitedict dropping any existing data (in practice we would keep this between sessions, since the data shouldn’t change).</p>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlitedict <span class="im">import</span> SqliteDict</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>metadata_store <span class="op">=</span> SqliteDict(<span class="st">'common_crawl_columnar_index_metadata.sqlite'</span>, flag<span class="op">=</span><span class="st">'w'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s configure our run and set up some datastructures for tracking.</p>
<p>We will only process jobs that aren’t in the metadata_store.</p>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>max_retries <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>max_exceptions_per_batch <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>retries <span class="op">=</span> defaultdict(<span class="bu">int</span>)</span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>exceptions <span class="op">=</span> defaultdict(<span class="bu">list</span>)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>seen <span class="op">=</span> <span class="bu">set</span>(metadata_store.keys())</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>jobs <span class="op">=</span> [x <span class="cf">for</span> x <span class="kw">in</span> http_files <span class="cf">if</span> x <span class="kw">not</span> <span class="kw">in</span> seen]</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(jobs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>25193</code></pre>
</div>
</div>
<p>We can now run through all the jobs</p>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tqdm(total<span class="op">=</span><span class="bu">len</span>(jobs)) <span class="im">as</span> pbar:</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="bu">len</span>(jobs) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>        batch <span class="op">=</span> jobs[:batch_size]</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>        batch_metadata <span class="op">=</span> <span class="cf">await</span>(fetch_parquet_metadata_http(batch))</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>        num_exceptions <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> job, metadata <span class="kw">in</span> <span class="bu">zip</span>(batch, batch_metadata):</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(metadata, <span class="pp">Exception</span>):</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>                num_exceptions <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>                exceptions[job].append(metadata)</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>                retries[job] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> retries[job] <span class="op">&gt;=</span> max_retries:</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>                    jobs.remove(job)</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">assert</span> <span class="bu">isinstance</span>(metadata, <span class="bu">bytes</span>)</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>                metadata_store[job] <span class="op">=</span> metadata</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>                jobs.remove(job)</span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>                pbar.update()</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>        metadata_store.commit()</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_exceptions <span class="op">&gt;=</span> max_exceptions_per_batch:</span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">'Too many exceptions </span><span class="sc">%i</span><span class="st">'</span> <span class="op">%</span> num_exceptions)</span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f'Finished in </span><span class="sc">{</span>time<span class="sc">.</span>time() <span class="op">-</span> start_time<span class="sc">:0.0f}</span><span class="ss">s'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"42a2a99a613940c8b26b0aad0771f11d","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished in 441s</code></pre>
</div>
</div>
<p>How many exceptions are raised?</p>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(retries), <span class="bu">sum</span>(retries.values())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>(0, 0)</code></pre>
</div>
</div>
<p>Now we have all the headers, we want to extract the relevant metadata.</p>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_column_metadata(column, row_group):</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>    matches <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> row_group.columns <span class="cf">if</span> col.meta_data.path_in_schema <span class="op">==</span> [column]]</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(matches) <span class="op">!=</span> <span class="dv">1</span>:</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(matches)</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> matches[<span class="dv">0</span>].meta_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>stats_columns <span class="op">=</span> [<span class="st">'url_surtkey'</span>]</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_row_group_metadata(k, v):</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    fmd <span class="op">=</span> from_buffer(v, <span class="st">"FileMetaData"</span>)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row_group <span class="kw">in</span> <span class="bu">enumerate</span>(fmd.row_groups):</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> {</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">'path'</span>: k[<span class="bu">len</span>(<span class="st">'https://data.commoncrawl.org/'</span>):],</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'crawl'</span>: k.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">3</span>].split(<span class="st">'='</span>)[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'subset'</span>:  k.split(<span class="st">'/'</span>)[<span class="op">-</span><span class="dv">2</span>].split(<span class="st">'='</span>)[<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'row_group'</span>: idx,</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'num_rows'</span>: row_group.num_rows,</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'byte_size'</span>: row_group.total_byte_size,</span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> stats_columns:</span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>            minimum <span class="op">=</span> get_column_metadata(col, row_group).statistics.min_value </span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>            maximum <span class="op">=</span> get_column_metadata(col, row_group).statistics.max_value</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(minimum, <span class="bu">bytes</span>):</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>                minimum <span class="op">=</span> minimum.decode(<span class="st">'utf-8'</span>)</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">isinstance</span>(maximum, <span class="bu">bytes</span>):</span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>                maximum <span class="op">=</span> maximum.decode(<span class="st">'utf-8'</span>)</span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>            result[<span class="ss">f'min_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> minimum</span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>            result[<span class="ss">f'max_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> maximum</span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_metadata(metadata_store):</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> tqdm(metadata_store.items(), total<span class="op">=</span><span class="bu">len</span>(metadata_store)):</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row <span class="kw">in</span> extract_row_group_metadata(k, v):</span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">yield</span> row        </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>df_metadata <span class="op">=</span> pd.DataFrame(extract_metadata(metadata_store))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b995343c076c4e8ab67c44362dbeee11","version_major":2,"version_minor":0}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 56s, sys: 3.51 s, total: 1min 59s
Wall time: 1min 56s</code></pre>
</div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>df_metadata.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>path</th>
      <th>crawl</th>
      <th>subset</th>
      <th>row_group</th>
      <th>num_rows</th>
      <th>byte_size</th>
      <th>min_url_surtkey</th>
      <th>max_url_surtkey</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2013...</td>
      <td>CC-MAIN-2013-20</td>
      <td>warc</td>
      <td>0</td>
      <td>1536416</td>
      <td>609417359</td>
      <td>1,103,63,50)/</td>
      <td>au,com,adelaidenow)/news/breaking-news/another...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2013...</td>
      <td>CC-MAIN-2013-20</td>
      <td>warc</td>
      <td>1</td>
      <td>35284</td>
      <td>14185475</td>
      <td>ar,com,buscouniversidad)/maestria-en-ciencias-...</td>
      <td>at,belvedere)/de/events/detail/die-nacht-im-zw...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2013...</td>
      <td>CC-MAIN-2013-20</td>
      <td>warc</td>
      <td>2</td>
      <td>1499082</td>
      <td>638601593</td>
      <td>ar,com,chubb)/</td>
      <td>at,gv,land-oberoesterreich)/cps/rde/xchg/sid-e...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2013...</td>
      <td>CC-MAIN-2013-20</td>
      <td>warc</td>
      <td>3</td>
      <td>1339494</td>
      <td>551235294</td>
      <td>ar,com,tripadvisor)/hotel_review-g580306-d1194...</td>
      <td>at,meinbezirk)/wien/wien-05-margareten/service</td>
    </tr>
    <tr>
      <th>4</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2013...</td>
      <td>CC-MAIN-2013-20</td>
      <td>warc</td>
      <td>4</td>
      <td>255538</td>
      <td>97165599</td>
      <td>at,meinbezirk)/wien/wien-05-margareten/themen/...</td>
      <td>at,parents)/forum/archive/index.php/t-182119.html</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>metadata_store.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>df_metadata.to_csv(<span class="st">'common_crawl_columnar_index_metadata.csv.gz'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Between 2017-43 and 2018-43 it looks like we may not have statistics for <code>url_surtkey</code> and would have to generate them.</p>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a> df_metadata</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a> .groupby(<span class="st">'crawl'</span>)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a> .agg(row_groups <span class="op">=</span> (<span class="st">'path'</span>, <span class="st">'count'</span>),</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>      files <span class="op">=</span> (<span class="st">'path'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>      min_url <span class="op">=</span> (<span class="st">'min_url_surtkey'</span>, <span class="st">'count'</span>),</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>      max_url <span class="op">=</span> (<span class="st">'max_url_surtkey'</span>, <span class="st">'count'</span>),</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  .query(<span class="st">'min_url != row_groups'</span>)</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>  .sort_index()</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>row_groups</th>
      <th>files</th>
      <th>min_url</th>
      <th>max_url</th>
    </tr>
    <tr>
      <th>crawl</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CC-MAIN-2017-43</th>
      <td>2476</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2017-47</th>
      <td>2199</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2017-51</th>
      <td>2035</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-05</th>
      <td>2361</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-09</th>
      <td>2369</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-13</th>
      <td>2250</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-17</th>
      <td>2119</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-22</th>
      <td>1950</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-26</th>
      <td>2121</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-30</th>
      <td>2251</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-34</th>
      <td>1888</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-39</th>
      <td>2018</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2018-43</th>
      <td>2150</td>
      <td>300</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>CC-MAIN-2019-18</th>
      <td>4230</td>
      <td>300</td>
      <td>4229</td>
      <td>4229</td>
    </tr>
    <tr>
      <th>CC-MAIN-2020-10</th>
      <td>4347</td>
      <td>299</td>
      <td>4344</td>
      <td>4344</td>
    </tr>
    <tr>
      <th>CC-MAIN-2020-16</th>
      <td>4261</td>
      <td>300</td>
      <td>4260</td>
      <td>4260</td>
    </tr>
    <tr>
      <th>CC-MAIN-2020-24</th>
      <td>3329</td>
      <td>300</td>
      <td>3328</td>
      <td>3328</td>
    </tr>
    <tr>
      <th>CC-MAIN-2020-34</th>
      <td>2957</td>
      <td>300</td>
      <td>2956</td>
      <td>2956</td>
    </tr>
    <tr>
      <th>CC-MAIN-2020-40</th>
      <td>4701</td>
      <td>300</td>
      <td>4700</td>
      <td>4700</td>
    </tr>
    <tr>
      <th>CC-MAIN-2020-50</th>
      <td>3542</td>
      <td>300</td>
      <td>3541</td>
      <td>3541</td>
    </tr>
    <tr>
      <th>CC-MAIN-2021-10</th>
      <td>3738</td>
      <td>300</td>
      <td>3737</td>
      <td>3737</td>
    </tr>
    <tr>
      <th>CC-MAIN-2021-17</th>
      <td>4223</td>
      <td>300</td>
      <td>4220</td>
      <td>4220</td>
    </tr>
    <tr>
      <th>CC-MAIN-2021-21</th>
      <td>3403</td>
      <td>300</td>
      <td>3401</td>
      <td>3401</td>
    </tr>
    <tr>
      <th>CC-MAIN-2021-25</th>
      <td>3321</td>
      <td>300</td>
      <td>3317</td>
      <td>3317</td>
    </tr>
    <tr>
      <th>CC-MAIN-2021-39</th>
      <td>3914</td>
      <td>300</td>
      <td>3912</td>
      <td>3912</td>
    </tr>
    <tr>
      <th>CC-MAIN-2021-43</th>
      <td>4547</td>
      <td>300</td>
      <td>4543</td>
      <td>4543</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
</section>
<section id="example-usage" class="level1">
<h1>Example usage</h1>
<p>Let’s suppose I wanted to find captures of commoncrawl.org, from 2020-24.</p>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> df_metadata.query(<span class="st">'crawl == "CC-MAIN-2020-24" &amp;</span><span class="ch">\</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="st">min_url_surtkey &lt;= "org,commoncrawl)/" &lt;= max_url_surtkey'</span>)</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>path</th>
      <th>crawl</th>
      <th>subset</th>
      <th>row_group</th>
      <th>num_rows</th>
      <th>byte_size</th>
      <th>min_url_surtkey</th>
      <th>max_url_surtkey</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>217771</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2020...</td>
      <td>CC-MAIN-2020-24</td>
      <td>warc</td>
      <td>0</td>
      <td>1730100</td>
      <td>550358211</td>
      <td>org,centerar,hr,ww17)/beauty/7-mitova-o-ljepot...</td>
      <td>org,copyrolexmenwatches)/pt/rolex-datejust-spe...</td>
    </tr>
    <tr>
      <th>217772</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2020...</td>
      <td>CC-MAIN-2020-24</td>
      <td>warc</td>
      <td>1</td>
      <td>1678910</td>
      <td>513173987</td>
      <td>org,chambresdhotes)/espanol/chambres_d_hotes/d...</td>
      <td>org,cpdl)/wiki/index.php?action=history&amp;title=...</td>
    </tr>
    <tr>
      <th>217773</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2020...</td>
      <td>CC-MAIN-2020-24</td>
      <td>warc</td>
      <td>2</td>
      <td>1908748</td>
      <td>583011770</td>
      <td>org,chinafia)/about/2-cn.html</td>
      <td>org,crchina)/constitution-of-the-peoples-repub...</td>
    </tr>
    <tr>
      <th>217774</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2020...</td>
      <td>CC-MAIN-2020-24</td>
      <td>warc</td>
      <td>3</td>
      <td>1730100</td>
      <td>537715703</td>
      <td>org,cinelatinoamericano)/cineasta.aspx?cod=4892</td>
      <td>org,cteresource)/verso/courses/8366/physical-o...</td>
    </tr>
    <tr>
      <th>217775</th>
      <td>cc-index/table/cc-main/warc/crawl=CC-MAIN-2020...</td>
      <td>CC-MAIN-2020-24</td>
      <td>warc</td>
      <td>4</td>
      <td>1880100</td>
      <td>541778479</td>
      <td>org,cleancitiessacramento)/photos.html</td>
      <td>org,ctrteam)/</td>
    </tr>
  </tbody>
</table>
</div>
</div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>path_to_row_groups <span class="op">=</span> (</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>    results</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'path'</span>)</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    .agg(row_groups <span class="op">=</span> (<span class="st">'row_group'</span>, <span class="bu">list</span>))</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'row_groups'</span>]</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>    .to_dict()</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>path_to_row_groups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>{'cc-index/table/cc-main/warc/crawl=CC-MAIN-2020-24/subset=warc/part-00245-b4a094ce-c3a1-4796-8c26-d927e48e4b4a.c000.gz.parquet': [0,
  1,
  2,
  3,
  4]}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>http_prefix <span class="op">=</span> <span class="st">'https://data.commoncrawl.org/'</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>search_ds <span class="op">=</span> ds.dataset([http_prefix <span class="op">+</span> path <span class="cf">for</span> path <span class="kw">in</span> path_to_row_groups], filesystem<span class="op">=</span>http, <span class="bu">format</span><span class="op">=</span><span class="st">'parquet'</span>, partitioning<span class="op">=</span><span class="st">'hive'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 38.8 ms, sys: 4.97 ms, total: 43.7 ms
Wall time: 1.51 s</code></pre>
</div>
</div>
<p>It could make sense to parallelise this to speed it up.</p>
<div class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>columns <span class="op">=</span> [<span class="st">'url'</span>, <span class="st">'url_host_name'</span>, <span class="st">'warc_filename'</span>, <span class="st">'warc_record_offset'</span>, <span class="st">'warc_record_length'</span>]</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>all_groups <span class="op">=</span> []</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> tqdm(total<span class="op">=</span><span class="bu">len</span>(results)) <span class="im">as</span> pbar:</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fragment <span class="kw">in</span> search_ds.get_fragments():</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>        path <span class="op">=</span> fragment.path[<span class="bu">len</span>(http_prefix):]</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>        row_groups <span class="op">=</span> fragment.split_by_row_group()</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row_group_idx <span class="kw">in</span> path_to_row_groups[path]:</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>            row_group <span class="op">=</span> row_groups[row_group_idx]</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> row_group.to_table(columns<span class="op">=</span>columns,</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>                                       <span class="bu">filter</span><span class="op">=</span>ds.field(<span class="st">'url_host_name'</span>) <span class="op">==</span> <span class="st">'commoncrawl.org'</span>)</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>                all_groups.append(data)</span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>            pbar.update()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e9874e76140041539ff5536a146c02f1","version_major":2,"version_minor":0}
</script>
</div>
</div>
<p>We can then look at some URLs.</p>
<div class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(all_groups)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>1</code></pre>
</div>
</div>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> pa.concat_tables(all_groups).to_pandas()</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">

<div>

<table class="dataframe table table-sm table-striped">
  <thead>
    <tr>
      <th></th>
      <th>url</th>
      <th>url_host_name</th>
      <th>warc_filename</th>
      <th>warc_record_offset</th>
      <th>warc_record_length</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>http://commoncrawl.org/</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590347435...</td>
      <td>27151522</td>
      <td>5448</td>
    </tr>
    <tr>
      <th>1</th>
      <td>https://commoncrawl.org/2010/10/slideshare-bui...</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>286036900</td>
      <td>5448</td>
    </tr>
    <tr>
      <th>2</th>
      <td>http://commoncrawl.org/2012/03/data-2-0-summit/</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>27155726</td>
      <td>7503</td>
    </tr>
    <tr>
      <th>3</th>
      <td>http://commoncrawl.org/2012/11/the-norvig-web-...</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>25681807</td>
      <td>6307</td>
    </tr>
    <tr>
      <th>4</th>
      <td>https://commoncrawl.org/2012/12/blekko-donates...</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>289331067</td>
      <td>6925</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>60</th>
      <td>http://commoncrawl.org/terms-of-use/</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>26795983</td>
      <td>6938</td>
    </tr>
    <tr>
      <th>61</th>
      <td>https://commoncrawl.org/terms-of-use/</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>285700698</td>
      <td>6982</td>
    </tr>
    <tr>
      <th>62</th>
      <td>http://commoncrawl.org/terms-of-use/full/</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>27794892</td>
      <td>11744</td>
    </tr>
    <tr>
      <th>63</th>
      <td>https://commoncrawl.org/terms-of-use/full/</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>290639475</td>
      <td>11778</td>
    </tr>
    <tr>
      <th>64</th>
      <td>https://commoncrawl.org/the-data/get-started/</td>
      <td>commoncrawl.org</td>
      <td>crawl-data/CC-MAIN-2020-24/segments/1590348521...</td>
      <td>292834731</td>
      <td>10750</td>
    </tr>
  </tbody>
</table>
<p>65 rows × 5 columns</p>
</div>
</div>
</div>
<p>Accessing a crawl</p>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>a <span class="op">=</span> results.iloc[<span class="dv">0</span>]</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">'https://data.commoncrawl.org/'</span> <span class="op">+</span> a.warc_filename</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>header <span class="op">=</span> {<span class="st">"Range"</span>: <span class="ss">f'bytes=</span><span class="sc">{</span>a<span class="sc">.</span>warc_record_offset<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>a<span class="sc">.</span>warc_record_offset <span class="op">+</span> a<span class="sc">.</span>warc_record_length<span class="sc">}</span><span class="ss">'</span>}</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> requests.get(url, headers<span class="op">=</span>header)</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>warc_data <span class="op">=</span> r.content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can then decompress and examine that WARC record.</p>
<div class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zlib</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> zlib.decompress(warc_data, wbits <span class="op">=</span> zlib.MAX_WBITS <span class="op">|</span> <span class="dv">16</span>)</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data.decode(<span class="st">'utf-8'</span>)[:<span class="dv">1500</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARC/1.0
WARC-Type: response
WARC-Date: 2020-06-03T17:59:17Z
WARC-Record-ID: &lt;urn:uuid:924c0b54-e18f-4fa2-883f-918ec07cc7aa&gt;
Content-Length: 21001
Content-Type: application/http; msgtype=response
WARC-Warcinfo-ID: &lt;urn:uuid:c9aa942a-7416-4367-8295-bf964f6be17a&gt;
WARC-Concurrent-To: &lt;urn:uuid:25e5d72e-1031-4d58-b6b0-2ae3991f5c91&gt;
WARC-IP-Address: 104.28.20.25
WARC-Target-URI: http://commoncrawl.org/
WARC-Payload-Digest: sha1:CIBK2YFSVPNDFLXUHSKZG2SPN7UNN65W
WARC-Block-Digest: sha1:4N6PX5ISYJ76FDBCKXEFSC2H63XK2AIG
WARC-Identified-Payload-Type: text/html

HTTP/1.1 200 OK
Date: Wed, 03 Jun 2020 17:59:17 GMT
Content-Type: text/html; charset=UTF-8
X-Crawler-Transfer-Encoding: chunked
Connection: keep-alive
Set-Cookie: __cfduid=d21b8d62b496908e52ebb3973abe637321591207157; expires=Fri, 03-Jul-20 17:59:17 GMT; path=/; domain=.commoncrawl.org; HttpOnly; SameSite=Lax
X-Powered-By: PHP/5.5.9-1ubuntu4.29
Link: &lt;http://commoncrawl.org/wp-json/&gt;; rel="https://api.w.org/"
Link: &lt;http://commoncrawl.org/&gt;; rel=shortlink
Vary: Accept-Encoding
Cache-Control: max-age=14400
CF-Cache-Status: HIT
Age: 6364
cf-request-id: 031cef789700000dde34a2b200000001
Server: cloudflare
CF-RAY: 59db4ea0f9bc0dde-IAD
X-Crawler-Content-Encoding: gzip
Content-Length: 20289


&lt;!DOCTYPE html&gt;
&lt;html lang="en-US"&gt;
&lt;head&gt;
&lt;meta charset="UTF-8"&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
&lt;link rel="profile" href="https://gmpg.org/xfn/11"&gt;
&lt;link href="https://fonts.go</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>