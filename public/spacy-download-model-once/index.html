<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-10-21">

<title>skeptric - Preventing SpaCy from re-downloading large models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">skeptric</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/EdwardJRoss"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Preventing SpaCy from re-downloading large models</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">annotation</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 21, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p><a href="https://spacy.io/">SpaCy</a> and <a href="https://prodi.gy/">Prodigy</a> are handy tools for natural language processing in Python, but are a pain to install in a reproducible way, say with a Makefile. Downloading a SpaCy model with <code>spacy download -m</code> will <em>always</em> re-download the model, which can be very time and bandwidth consuming for large models. Prodigy is a paid product and can’t be installed from PyPI.</p>
<p>My solution for this is to generate a file containing the links to all the SpaCy models.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">"Accept: application/vnd.github+json"</span> <span class="dt">\</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  https://api.github.com/repos/explosion/spacy-models/releases <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">jq</span> <span class="st">'.[].assets[].browser_download_url'</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">awk</span> <span class="st">'BEGIN {print "&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;"}</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">       {print "&lt;a href=" $0 "&gt;" gensub("\"|.*/", "", "g") "&lt;/a&gt;&lt;br/&gt;"}</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">       END {print "&lt;/body&gt;&lt;/html&gt;"}'</span> <span class="dt">\</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;</span> spacy_model_links.html</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then a model can be installed with pip, for example <code>pip install -f spacy_model_links.html 'en_core_web_trf&gt;=3.4.0&lt;3.5'</code>. If you run the command twice it will check the dependencies (which takes seconds) but it won’t re-download the model (which can take minutes).</p>
<p>This article will show how to install SpaCy models and Prodigy quickly and reproducibly using <code>make</code> and <a href="https://github.com/jazzband/pip-tools">pip-tools</a>. It will explain how installing SpaCy model packages works, and why it downloads the model <em>every</em> time, and some workarounds. Then it will go into how to install Prodigy (if you have a licence) and look deeper into how <code>-f</code> works in pip. The next section will look into how to use these with <code>pip-tools</code> to create a robust build process that won’t break when you try it in a new environment. Finally it will explain the shell script above (and a pure Python version), giving a simpler process for working with SpaCy models.</p>
<p>The main assumption is that you’re using a *nix system (for Windows users I recommend <a href="../wsl2-start">wsl2</a>), that you’re using the same version of Python everywhere (using something like <a href="https://github.com/pyenv/pyenv">pyenv</a> or <a href="https://docs.conda.io/en/latest/">conda</a>/<a href="https://github.com/mamba-org/mamba">mamba</a> to manage Python versions). Also you should be using some sort of virtual environment.</p>
<section id="installing-spacy-models" class="level1">
<h1>Installing SpaCy Models</h1>
<p>The documented way to download a model in SpaCy is something like <code>spacy download -m &lt;model_name&gt;</code>, which can then be used in python with <code>spacy.load</code>. The problem is that every time <code>spacy download</code> is run it downloads the model again, even if it’s already been downloaded. Transformer models like <code>en_core_web_trf</code> are hundreds of megabytes so this can take significant time and space.</p>
<p>In fact using <code>spacy download</code> is not recommended for an automated process; from the <a href="https://spacy.io/api/cli#download">documentation</a></p>
<blockquote class="blockquote">
<p>The download command is mostly intended as a convenient, interactive wrapper – it performs compatibility checks and prints detailed messages in case things go wrong. It’s not recommended to use this command as part of an automated process. If you know which package your project needs, you should consider a direct download via pip, or uploading the package to a local PyPi installation and fetching it straight from there. This will also allow you to add it as a versioned package dependency to your project.</p>
</blockquote>
<section id="downloading-models-with-pip" class="level2">
<h2 class="anchored" data-anchor-id="downloading-models-with-pip">Downloading models with pip</h2>
<p>When you run <code>spacy download</code> it will output something like</p>
<pre><code># python -m spacy download en_core_web_trf
Collecting en-core-web-trf==3.4.1
  Downloading https://github.com/explosion/spacy-models/releases/download/en_core_web_trf-3.4.1/en_core_web_trf-3.4.1-py3-none-any.whl (460.3 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 460.3/460.3 MB 1.1 MB/s eta 0:00:00</code></pre>
<p>You can just copy the URL above into a <code>requirements.txt</code> file and install it directly using <code>pip install</code>. The catch is that <code>pip install</code> will always re-download the model each time you run it; it has no way of telling whether the package at the URL is the same as the one already installed.</p>
<p>In fact this was raised as <a href="https://github.com/explosion/spaCy/issues/1143">an issue</a> back in 2017, which was solved by appending <code>#egg=</code> to the URL (which somehow convinced <code>pip</code> this was the same package). However this was <a href="https://pip.pypa.io/en/stable/news/#id193">removed in <code>pip</code> 21.2 (July 2021)</a> so that:</p>
<blockquote class="blockquote">
<p>Most of the fragment part, including egg=, is explicitly ignored. Only subdirectory= and hash values (e.g.&nbsp;sha256=) are kept.</p>
</blockquote>
</section>
<section id="downloading-models-only-once" class="level2">
<h2 class="anchored" data-anchor-id="downloading-models-only-once">Downloading models only once</h2>
<p>One way to solve this would be to check if it’s already installed, and only then install it. For example the following command will return a non-zero status only if <code>en_core_web_trf</code> is not installed.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-c</span> <span class="st">'import importlib.util; assert importlib.util.find_spec("en_core_web_trf") is not None'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>A more robust approach is to use <a href="https://pip.pypa.io/en/stable/cli/pip_download/"><code>pip download</code></a> to download the files to a local directory, and then install from there. For example if you put all the model files in a <code>requirements-model.txt</code> you can download them to the <code>build/</code> folder using</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> download <span class="at">-r</span> requirements-model.txt <span class="at">--no-deps</span> <span class="at">--dest</span> build/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The best thing is if you run this twice it doesn’t download the files a second time. You can then <code>pip install</code> the files from the <code>build/</code> directory.</p>
</section>
<section id="putting-it-into-a-workflow" class="level2">
<h2 class="anchored" data-anchor-id="putting-it-into-a-workflow">Putting it into a workflow</h2>
<p>The strategy to tie this all together is:</p>
<ol type="1">
<li>Create a <code>requirements-model.txt</code> file with the model requirements</li>
<li>Create a <code>requirements.in</code> file with all the other requirements</li>
<li>Every time either file changes, download the models and produce a <code>requirements.txt</code> file</li>
</ol>
<p>We can list the directory of <code>build/</code> to find all the downloaded model files to install. This can be done with a Makefile like the following:</p>
<pre class="make"><code>requirements.txt: requirements.in requirements-model.txt
    pip download -r requirements-model.txt --no-deps --dest build/
    cp requirements.in requirements.txt
    find build/ -type f &gt;&gt; requirements.txt

install: requirements.txt
    pip install -r requirements.txt</code></pre>
</section>
<section id="gotchas" class="level2">
<h2 class="anchored" data-anchor-id="gotchas">Gotchas</h2>
<p>The main limitation here is you have to manage the dependencies for model versions yourself. If you want to upgrade SpaCy, you’ll have to manually update all the <code>requirements-model.txt</code> files to the compatible models. As a result you should restrict SpaCy to a major version (e.g.&nbsp;<code>&gt;=3.4.0,&lt;3.5.0</code>) until you’re ready to upgrade.</p>
</section>
</section>
<section id="installing-prodigy" class="level1">
<h1>Installing Prodigy</h1>
<p>Prodigy is a commercial, closed-source, standalone Python application, and so is not available on PyPI. However while your license is valid for upgrades they allow <a href="https://prodi.gy/docs/install#pip">installation via pip</a> authenticating with your license key.</p>
<pre><code>pip install prodigy -f https://XXXX-XXXX-XXXX-XXXX@download.prodi.gy</code></pre>
<p>This works because <code>-f</code> is the same as <a href="https://pip.pypa.io/en/stable/cli/pip_install/#install-find-links">–find-links</a></p>
<pre><code>If a URL or path to an html file, then parse for links to archives such as sdist (.tar.gz) or wheel (.whl) files. If a local path or file:// URL that’s a directory, then look for archives in the directory listing. Links to VCS project URLs are not supported.</code></pre>
<p>In this case the URL above the license key before the <code>@</code> sign as <a href="https://superuser.com/a/1578499">user info for authentication</a>. When the login is valid a HTML file is served containing all the prodigy releases with hyperlinks to the package files. Pip can then use these to find the relevant release.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/prodigy_download.jpg" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Example of Prodigy download page</figcaption><p></p>
</figure>
</div>
<section id="keeping-credentials-secret" class="level2">
<h2 class="anchored" data-anchor-id="keeping-credentials-secret">Keeping credentials secret</h2>
<p>The problem is if you put this line in a Makefile it will echo your secret license key as it runs the command, which may end up exposed in a log somewhere. You can silence the whole line, but then it’s harder to debug what’s going on.</p>
<p>A better solution is to use the <code>PIP_FIND_LINKS</code> <a href="https://pip.pypa.io/en/stable/topics/configuration/#environment-variables">environment variable for configuration</a>. As long as you include the prodigy URL above in this variable you don’t need to explicitly pass it in <code>-f</code> and so make won’t print it out. Pip will echo the links but is smart enough to mask the sensitive user info.</p>
<pre><code>Looking in links: https://****@download.prodi.gy</code></pre>
<p>One way to set the variable is to have a <code>.env</code> file in <code>.gitignore</code> like this, and <code>include .env</code> in your Makefile. Here’s what it could look like.</p>
<pre><code>PRODIGY_KEY=XXXX-XXXX-XXXX-XXXX
export PIP_FIND_LINKS=https://${PRODIGY_KEY}@download.prodi.gy</code></pre>
</section>
</section>
<section id="reproducible-builds-with-pip-tools" class="level1">
<h1>Reproducible builds with pip-tools</h1>
<p>One problem with model pipelines is a change in a dependency can suddenly break or change the behaviour. When you’re trying to run the same code in different environments this can be really hard to debug. As an example I’ve have Pandas break handling of nullable fields between releases. A good way to handle this is to pin the versions of all dependencies (that is use one specific version), and have a separate process to upgrade the dependencies periodically (and check the tests pass). The <a href="https://github.com/jazzband/pip-tools">pip-tools</a> library provides a good way to do it.</p>
<p>You specify your dependencies in a <code>requirements.in</code> file, run <code>pip-compile</code> to generate a <code>requirements.txt</code> file (optionally with <code>--upgrade</code> to upgrade dependencies), and <code>pip-sync</code> to install them into your environment. To make things even more secure you can pass <code>--generate-hashes</code> which will check the hashes of all the files to check nothing has been changed. It also works with <code>pyproject.toml</code> and other ways of specifying inputs, and it works well. There are other solutions to this like <a href="https://python-poetry.org/">poetry</a> but pip-tools is less opinionated and simpler for a standalone project that’s not being published to PyPI.</p>
<section id="keeping-credentials-secret-with-pip-tools" class="level2">
<h2 class="anchored" data-anchor-id="keeping-credentials-secret-with-pip-tools">Keeping credentials secret with pip-tools</h2>
<p>To make things reproducible <code>pip-tools compile</code> will output all the <code>find-links</code> in the <code>requirements.txt</code> file, which should be committed. This is a problem because we have our license key secret in our links, but it can be turned off with <code>--no-emit-find-links</code>.</p>
</section>
<section id="stop-trying-to-reinstall-things-already-installed" class="level2">
<h2 class="anchored" data-anchor-id="stop-trying-to-reinstall-things-already-installed">Stop trying to reinstall things already installed</h2>
<p>For URL or file dependencies, <code>pip-sync</code> will uninstall and reinstall them each time it’s run. This makes it a bit slower to use each time.</p>
<p>A workaround for this is to use <code>--find-links</code> with the <code>build</code> directory itself, and pass the package names into <code>pip-compile</code>.</p>
<p>Here’s an example workflow, you could have a <code>requirements-model.in.raw</code> file that looks like this:</p>
<pre><code>https://github.com/explosion/spacy-models/releases/download/en_core_web_trf-3.4.0/en_core_web_trf-3.4.0-py3-none-any.whl</code></pre>
<p>Then in the Makefile you could download all the requirements into <code>build</code> and produce a <code>requirements-model.in</code> file with the package names:</p>
<pre class="make"><code>requirements-model.in: requirements-model.in.url
    mkdir -p build/
    pip download -r requirements-model.txt --no-deps --dest build/
    ls build/ | sed 's/-.*//' &gt; requirements-download.in</code></pre>
<p>Then when we want to install the dependencies we can <code>pip-compile</code> the files and run <code>pip-sync</code>:</p>
<pre><code>requirements.txt: requirements.in requirements-model.in
    python -m piptools compile --no-emit-find-links --generate-hashes \
        --find-links build/ \
        --output-file requirements.txt \
        requirements.in requirements-model.in

install: requirements.txt
    python -m piptools sync --find-links ./build/ requirements.txt</code></pre>
</section>
</section>
<section id="is-there-an-easier-way" class="level1">
<h1>Is there an easier way?</h1>
<p>All these workarounds are because there’s no way for pip to align the package versions to a URL. If we had each SpaCy model’s name with a link to its package in a HTML page (like Prodigy does) then pip could resolve the links.</p>
<p>We can easily build this because all the models are on the <a href="https://github.com/explosion/spacy-models/releases">spacy-models release page</a>. Using the <a href="https://docs.github.com/en/rest/releases/releases#list-releases">Github releases API</a> we can do this with a bit of shell scripting.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="dt">\</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">"Accept: application/vnd.github+json"</span> <span class="dt">\</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  https://api.github.com/repos/explosion/spacy-models/releases <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">jq</span> <span class="st">'.[].assets[].browser_download_url'</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">awk</span> <span class="st">'BEGIN {print "&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;"}</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="st">       {print "&lt;a href=" $0 "&gt;" gensub("\"|.*/", "", "g") "&lt;/a&gt;&lt;br/&gt;"}</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="st">       END {print "&lt;/body&gt;&lt;/html&gt;"}'</span> <span class="dt">\</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">&gt;</span> spacy_model_links.html</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Or equivalently in Python we can get all the URLs using the API.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_spacy_model_links() <span class="op">-&gt;</span> List[<span class="bu">str</span>]:</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    url <span class="op">=</span> <span class="st">"https://api.github.com/repos/explosion/spacy-models/releases"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    headers <span class="op">=</span> {<span class="st">"Accept"</span>: <span class="st">"application/vnd.github+json"</span>}</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    req <span class="op">=</span> urllib.request.Request(url, headers<span class="op">=</span>headers)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> urllib.request.urlopen(req) <span class="im">as</span> response:</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> json.loads(response.read())</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        links <span class="op">=</span> [</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>            asset[<span class="st">"browser_download_url"</span>]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> release <span class="kw">in</span> data</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> asset <span class="kw">in</span> release[<span class="st">"assets"</span>]</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> links</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then we can combine the links into an HTML document that pip can understand:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spacy_model_links_to_html(links: List[<span class="bu">str</span>]) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    html <span class="op">=</span> [<span class="st">"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;"</span>]</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> link <span class="kw">in</span> links:</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        html.append(<span class="ss">f'&lt;a href="</span><span class="sc">{</span>link<span class="sc">}</span><span class="ss">"&gt;</span><span class="sc">{</span>link<span class="sc">.</span>split(<span class="st">"/"</span>)[<span class="op">-</span><span class="dv">1</span>]<span class="sc">}</span><span class="ss">&lt;/a&gt;&lt;br/&gt;'</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    html.append(<span class="st">"&lt;/body&gt;&lt;/html&gt;"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>.join(html)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="simplified-process" class="level2">
<h2 class="anchored" data-anchor-id="simplified-process">Simplified process</h2>
<p>Now that we have the links we can treat a SpaCy model like any other dependency. We just have a single <code>requirements.in</code> file and can specify a version such as <code>en_core_web_trf&gt;=3.4.0,&lt;3.5.0</code>. It even checks and resolves the model’s dependencies correctly.</p>
<p>Our Makefile is now relatively simple:</p>
<pre class="make"><code>requirements.txt: requirements.in
    python -m piptools compile -q --no-emit-find-links \
    --find-links spacy_model_links.html

install: requirements.txt
    python -m piptools sync \
    --find-links spacy_model_links.html</code></pre>
<p>My question is why SpaCy doesn’t provide something like this. If this HTML links page was republished somewhere with every release, then I could just point to it with <code>find-links</code> (assuming there’s good reason they aren’t in PyPI). But this simple solution of generating a file works until they provide a better way.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>