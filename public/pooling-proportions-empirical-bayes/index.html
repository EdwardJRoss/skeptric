<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2022-02-07">

<title>skeptric - Pooling Proportions with Empirical Bayes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">skeptric</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/EdwardJRoss"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Pooling Proportions with Empirical Bayes</h1>
  <div class="quarto-categories">
    <div class="quarto-category">statistics</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 7, 2022</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>Calculating binomial proportions by group is inherently noisy for small groups. The standard deviation for a group is <span class="math inline">\(\sqrt{\frac{p(1-p)}{N}}\)</span>, where <span class="math inline">\(p\)</span> is the true proportion of the group and <span class="math inline">\(N\)</span> the size of the group. The numerator is always at least as large as the distance to 0 or 1, so for small <span class="math inline">\(N\)</span> the uncertainty is very large relative to the measurement. The resolution of the measurement is at most <span class="math inline">\(1/N\)</span>; with <span class="math inline">\(N=2\)</span> the only possible outcomes are 0%, 50% or 100%. Because of this in rankings the small groups are always near the top and the bottom.</p>
<p>There is a better way to calculate binomial proportions by pooling information across groups. Given the conversion rate over several channels, we know something about the conversion rate for a new unseen channel. The rates of each group can be considered a distribution, and modelled as a hierarchical model. Then a new group starts near the centre of this distribution, and as more data on the group is collected it moves towards the independent group average. The small groups are all pulled to the centre of the distribution, away from the edges of the ranking.</p>
<p>For a binomial distribution the conjugate prior is the <a href="../beta-distribution">beta distribution</a>, which seems like a reasonable start. We could estimate this distribution with standard Bayesian computational techniques such as Markov Chain Monte Carlo, but we can analytically reduce the likelihood into something that can be computed directly. The maximum likelihood estimate (or any other estimate) can be plugged in and the group averages estimated, an Empirical Bayes approach.</p>
<section id="model-and-group-estimates" class="level1">
<h1>Model and Group Estimates</h1>
<p>The data is from m groups, with group <span class="math inline">\(i\)</span> containing <span class="math inline">\(N_i\)</span> dichotomous outcomes of which <span class="math inline">\(k_i\)</span> are positive. The group is modelled as a binomial with probability <span class="math inline">\(\theta_i\)</span>, which is the group average we are trying to infer. The groups probabilities are modelled as a Beta distribution where the parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> are to be inferred.</p>
<p><span class="math display">\[\begin{align}
\theta_i &amp; \sim {\rm Beta}(\alpha, \beta) \\
k_i &amp; \sim {\rm Binomial}(N_i, \theta_i) \; \forall i=1,\ldots,m
\end{align}\]</span></p>
<p>Given <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> the posterior estimates are</p>
<p><span class="math display">\[\hat{\theta}_i = \frac{k_i + \alpha - 1 }{N_i + \alpha + \beta - 2}\]</span></p>
<p>That is the prior is effectively starting at <span class="math inline">\(\alpha+\beta-2\)</span> outcomes, of which <span class="math inline">\(\alpha-1\)</span> are positive and <span class="math inline">\(\beta-1\)</span> are negative. This standard notation is asymmetrical; using the sample strength <span class="math inline">\(\kappa = \alpha + \beta\)</span> it’s a more symmetrical (but still plagued by off-by-one adjustments).</p>
<p><span class="math display">\[\hat{\theta}_i = \frac{k_i + \alpha - 1 }{N_i + \kappa - 2}\]</span></p>
<p>In fact it can be seen as a weighted average of the group average and the prior average from the Beta distribtuion. The direct estimate of probability is <span class="math inline">\(p_i = k_i/N_i\)</span>, and the mode of the Beta function is <span class="math inline">\(\omega = \frac{\alpha-1}{\kappa-2}\)</span> (for <span class="math inline">\(\kappa &gt; 2\)</span>). Then</p>
<p><span class="math display">\[\hat{\theta}_i = \frac{N_i p_i + (\kappa - 2) \omega }{N_i + (\kappa - 2)}\]</span></p>
</section>
<section id="estimating-the-beta-distribution" class="level1">
<h1>Estimating the Beta Distribution</h1>
<p>Any estimate of the Beta Distribution will work. <a href="http://www.probabilaball.com/2015/05/beta-binomial-empirical-bayes.html">Probabilaball</a> has an example <a href="https://github.com/Probabilaball/Blog-Code/tree/master/Beta-Binomial-Empirical-Bayes">with code</a> of using the method of moments estimator (there’s also a brief example in Casella’s <a href="https://www.biostat.jhsph.edu/~fdominic/teaching/bio656/labs/labs09/Casella.EmpBayes.pdf">An Introduction to Empirical Bayes Data Analysis</a>). However the maximum likelihood estimator has many nice properties, and examining the likelihood shows the sensitivity to the parameters.</p>
<p>We want to find the dependence of the binomial outcomes on the hyper-priors <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> alone. For now just consider one group and drop the group index for simplicity. From our distributional model assumptions we have the following probability distributions:</p>
<p><span class="math display">\[\begin{align}
P(\theta \vert \alpha, \beta) &amp;=  \frac{\theta^{\alpha-1}(1-\theta)^{\beta-1}}{B(\alpha, \beta)} \\
P(k \vert N, \theta) &amp;=  {N \choose k} \theta^{k}(1-\theta)^{N-k}
\end{align}\]</span></p>
<p>We can easily simulate a distribution in R; I find it useful for explicitly checking the calculations</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="dv">10</span>         <span class="co"># alpha</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="dv">20</span>         <span class="co"># beta</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">5</span>          <span class="co"># Number of Trials</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>nsim <span class="ot">&lt;-</span> <span class="dv">10000</span>   <span class="co"># Number of simulations</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>N        <span class="co"># All possible values of positive outcomes</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(nsim, a, b)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>k_sim <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(nsim, N, theta)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulated probability distribution</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>psim <span class="ot">&lt;-</span> <span class="fu">table</span>(k_sim)<span class="sc">/</span><span class="fu">length</span>(k_sim)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">#      0      1      2      3      4      5</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.1463 0.3227 0.3060 0.1641 0.0535 0.0074</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can obtain the marginal distribution by integrating out <span class="math inline">\(\theta\)</span> using the law of total probability, and simplifying with conditional independence. This can be done for a wide range of models, called <a href="http://people.csail.mit.edu/jrennie/trg/papers/kass-bayesian-89.pdf">Conditionally Independent Hierarchical Models</a>, see also the derivation for a <a href="../james-stein-bayes">hierarchical normal distribution with known variance</a></p>
<p><span class="math display">\[\begin{align}
P(k \vert \alpha, \beta, N) &amp;= \int_0^1 {\rm{d}\,\theta} P(k \vert \alpha, \beta, N, \theta) P(\theta \vert \alpha,\beta, N)  \\
&amp;= \int_0^1  P(k \vert \theta, N) P(\theta \vert \alpha,\beta) {\rm{d}\,\theta}
\end{align}\]</span></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>integrand <span class="ot">&lt;-</span> <span class="cf">function</span>(k) <span class="cf">function</span>(theta) {<span class="fu">dbinom</span>(k, N, theta) <span class="sc">*</span> <span class="fu">dbeta</span>(theta, a, b)}</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>pnumeric <span class="ot">&lt;-</span> <span class="fu">vapply</span>(k, <span class="cf">function</span>(x) <span class="fu">integrate</span>(<span class="fu">integrand</span>(x), <span class="dv">0</span>,<span class="dv">1</span>)<span class="sc">$</span>value, <span class="fu">double</span>(<span class="dv">1</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># These should be about the same and give a ratio close to 1</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>pnumeric <span class="sc">/</span> psim</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#         0         1         2         3         4         5</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.0440972 0.9861547 0.9947580 1.0117864 0.9605892 0.9722721</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This integral can be evaluated analytically using the <a href="../beta-function">Beta function</a></p>
<p><span class="math display">\[\begin{align}
P(k \vert \alpha, \beta, N) &amp;= {N \choose k} \frac{1}{B(\alpha, \beta)} \int_0^1  \theta^{k+\alpha-1} (1-\theta)^{N-k+\beta-1} {\rm{d}\,\theta} \\
&amp;= {N \choose k} \frac{B(k+\alpha, N-k+\beta)}{B(\alpha, \beta)}
\end{align}
\]</span></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="dv">0</span><span class="sc">:</span>N</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>panalytic <span class="ot">&lt;-</span> <span class="fu">choose</span>(N, k) <span class="sc">*</span> <span class="fu">beta</span>(k<span class="sc">+</span>a, N<span class="sc">-</span>k<span class="sc">+</span>b)<span class="sc">/</span> <span class="fu">beta</span>(a,b)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>panalytic<span class="sc">/</span>psim</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Ratio is close to 1</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#        0         1         2         3         4         5</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">#1.0440972 0.9861547 0.9947580 1.0117864 0.9605892 0.9722721</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This is numerically unstable; the Beta function evaluates to very small numbers. It is much better to work in the logarithmic scale.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>logp <span class="ot">&lt;-</span> <span class="fu">lchoose</span>(N,z) <span class="sc">+</span> <span class="fu">lbeta</span>(z<span class="sc">+</span>a, N<span class="sc">-</span>z<span class="sc">+</span>b) <span class="sc">-</span> <span class="fu">lbeta</span>(a,b)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(logp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Going from one to multiple groups just requires multiplying together all the likelihoods, or equivalently summing the log likelihoods.</p>
</section>
<section id="maximum-likelihood-estimates" class="level1">
<h1>Maximum Likelihood Estimates</h1>
<p>To show how to obtain the maximum likelihood estimates let’s use a simulation with 14 groups.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6011</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>a0 <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>Ns <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="dv">10</span><span class="sc">^</span>(<span class="fu">runif</span>(m, <span class="dv">1</span>, <span class="fl">2.7</span>)))</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>Ns</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 20  30 299  21  22 249  35 133  58 247  51  73 312 479</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>theta <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(m, a0, b0)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>theta</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.247 0.456 0.255 0.290 0.321 0.313 0.343</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.360 0.284 0.384 0.294 0.380 0.528 0.286</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>ks <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(m, Ns, theta)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>ks</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 85 109   8 152  46   8  55  12   9  27  84  12  23  14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>For a given set of k and N we can calculate the negative log likelihood as above:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>negloglik <span class="ot">&lt;-</span> <span class="cf">function</span>(a,b) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">lchoose</span>(Ns,ks) <span class="sc">+</span> <span class="fu">lbeta</span>(ks<span class="sc">+</span>a, Ns<span class="sc">-</span>ks<span class="sc">+</span>b) <span class="sc">-</span> <span class="fu">lbeta</span>(a,b))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since there are only two parameters we can do a brute force search. I find it easier to think about in terms of the mode <span class="math inline">\(\omega\)</span> and strength <span class="math inline">\(\kappa\)</span>, or <span class="math inline">\(\tau = \kappa - 2\)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>omega <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">by=</span><span class="fl">0.01</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>,<span class="dv">500</span>,<span class="at">by=</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>omega <span class="ot">&lt;-</span> <span class="fu">rep</span>(omega, <span class="at">times=</span><span class="fu">length</span>(tau))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fu">rep</span>(tau, <span class="at">each=</span><span class="fu">length</span>(omega)<span class="sc">/</span><span class="fu">length</span>(tau))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> omega <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">-</span>omega) <span class="sc">*</span> tau <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ll for log likelihood</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span> ({ ll <span class="ot">&lt;-</span> <span class="fu">mapply</span>(negloglik, a, b) })</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>idx <span class="ot">=</span> <span class="fu">which</span>(ll <span class="sc">==</span> <span class="fu">min</span>(ll))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(omega[idx], tau[idx], a[idx], b[idx])</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 0.35 27.00 10.45 18.55</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Brute force searching gives an estimate close to the original parameters. It also allows us to plot the distribution easily, with the true value as a point in red. Notice that the negative log likelihood increases fast as <span class="math inline">\(\omega\)</span> gets far from the true value, but relatively slowly for larger sample strengths.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/beta_binomial_simulation_logliklihood.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Log likelihood of parameters from data</figcaption><p></p>
</figure>
</div>
<p>A more efficient way of finding the maximum is to find the zero of the derivatives of the negative log likelihood in terms of the <a href="https://en.wikipedia.org/wiki/Digamma_function">digamma function</a>:</p>
<p><span class="math display">\[\begin{align}
\frac{\partial l}{\partial \alpha} &amp;= \sum_{i=1}^{m} \psi(k_i + \alpha) - \psi(N_i + \alpha + \beta) + \psi(\alpha + \beta) - \psi(\alpha)\\
\frac{\partial l}{\partial \beta} &amp;= \sum_{i=1}^{m} \psi(N_i - k_i + \beta) - \psi(N_i + \alpha + \beta) + \psi(\alpha + \beta) - \psi(\beta)\\
\end{align}
\]</span></p>
<p>Or in code the derivatives of the negative log likelihoods are:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>d_nll_by_a <span class="ot">&lt;-</span> <span class="cf">function</span>(a,b) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">digamma</span>(ks<span class="sc">+</span>a)  <span class="sc">-</span> <span class="fu">digamma</span>(a) <span class="sc">+</span> <span class="fu">digamma</span>(a<span class="sc">+</span>b) <span class="sc">-</span> <span class="fu">digamma</span>(Ns<span class="sc">+</span>a<span class="sc">+</span>b))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>d_nll_by_b <span class="ot">&lt;-</span> <span class="cf">function</span>(a,b) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">digamma</span>(Ns<span class="sc">-</span>ks<span class="sc">+</span>b)  <span class="sc">-</span> <span class="fu">digamma</span>(b) <span class="sc">+</span> <span class="fu">digamma</span>(a<span class="sc">+</span>b) <span class="sc">-</span> <span class="fu">digamma</span>(Ns<span class="sc">+</span>a<span class="sc">+</span>b))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It seems there’s a unique global maximum and we can solve for it numerically. For an initial estimate use that the mean of the distribution is approximately the mean of the groups, and the variance is approximately the variance of the groups. These can then be rearranged to get <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> (see the article on the <a href="../beta-distribution">beta distribution</a> for details). For our starting point we can use a rough approximation.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>initial_guess <span class="ot">&lt;-</span> <span class="cf">function</span>(Ns, ks) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    mu <span class="ot">&lt;-</span> <span class="fu">mean</span>(ks<span class="sc">/</span>Ns)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">&lt;-</span> p0<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>p0)<span class="sc">/</span><span class="fu">var</span>(ks<span class="sc">/</span>Ns)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(mu<span class="sc">*</span>k, (<span class="dv">1</span><span class="sc">-</span>mu)<span class="sc">*</span>k)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="fu">initial_guess</span>(ks, Ns)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 5.538467 9.011807</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then the package <a href="https://cran.r-project.org/web/packages/rootSolve/index.html">rootSolve</a> can be used to quickly find the minimum. A quick check shows this is lower than any value found in the grid search.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> rootSolve<span class="sc">::</span><span class="fu">multiroot</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">function</span>(x) <span class="fu">c</span>(<span class="at">d1=</span><span class="fu">d_nll_by_a</span>(x[<span class="dv">1</span>], x[<span class="dv">2</span>]),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">d2=</span><span class="fu">d_nll_by_b</span>(x[<span class="dv">1</span>],x[<span class="dv">2</span>])),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">start=</span><span class="fu">initial_guess</span>(Ns, ks))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#  $root</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 10.31818 18.43713</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># $f.root</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">#            d1            d2</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">#  1.602294e-07 -1.824109e-07</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># $iter</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 6</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co"># $estim.precis</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># [1] 1.713201e-07</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ideally all this would be wrapped up in some library that makes this easy to use. This is a better default for calculating group proportions than the simple average.</p>
<p>We can then put this estimate to improve the raw estimate <span class="math inline">\(p=k/N\)</span> to <span class="math inline">\(\hat{p} = \frac{k+\alpha-1}{N+\alpha+\beta-2}\)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ahat <span class="ot">&lt;-</span> r<span class="sc">$</span>root[<span class="dv">1</span>]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>bhat <span class="ot">&lt;-</span> r<span class="sc">$</span>root[<span class="dv">2</span>]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(theta,Ns,ks,<span class="at">p=</span>ks<span class="sc">/</span>Ns,<span class="at">phat=</span>(ks<span class="sc">+</span>ahat<span class="dv">-1</span>)<span class="sc">/</span>(Ns<span class="sc">+</span>ahat<span class="sc">+</span>bhat<span class="dv">-2</span>))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>p_error <span class="ot">&lt;-</span> df<span class="sc">$</span>theta <span class="sc">-</span> df<span class="sc">$</span>p</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>phat_error <span class="ot">&lt;-</span> df<span class="sc">$</span>theta <span class="sc">-</span> df<span class="sc">$</span>phat</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table">
<thead>
<tr class="header">
<th style="text-align: right;">theta</th>
<th style="text-align: right;">Ns</th>
<th style="text-align: right;">ks</th>
<th style="text-align: right;">p</th>
<th style="text-align: right;">phat</th>
<th style="text-align: right;">p_error</th>
<th style="text-align: right;">phat_error</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">392</td>
<td style="text-align: right;">85</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.02</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">250</td>
<td style="text-align: right;">109</td>
<td style="text-align: right;">0.44</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.57</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">-0.32</td>
<td style="text-align: right;">-0.17</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">471</td>
<td style="text-align: right;">152</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">-0.03</td>
<td style="text-align: right;">-0.03</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">121</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">-0.06</td>
<td style="text-align: right;">-0.05</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.44</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">-0.13</td>
<td style="text-align: right;">-0.07</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.34</td>
<td style="text-align: right;">141</td>
<td style="text-align: right;">55</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">-0.05</td>
<td style="text-align: right;">-0.04</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.04</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">35</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">-0.01</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">27</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.01</td>
<td style="text-align: right;">0.02</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">326</td>
<td style="text-align: right;">84</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.03</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">12</td>
<td style="text-align: right;">0.60</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">-0.22</td>
<td style="text-align: right;">-0.08</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">42</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0.55</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">-0.02</td>
<td style="text-align: right;">0.06</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">0.26</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.03</td>
</tr>
</tbody>
</table>
<p>Notice that the error is much smaller for <span class="math inline">\(\hat{p}\)</span> when <span class="math inline">\(N\)</span> is small. In particular the most extreme value of p, when N=20, gets shrunk down closer to the true value. The RMSE for <span class="math inline">\(\hat{p}\)</span> is 0.05, much smaller than the RMSE for <span class="math inline">\(p\)</span> of 0.18.</p>
<p>This should be the default way of calculating proportions. David Robinson has provided the <a href="https://github.com/dgrtwo/ebbr">ebbr R package</a>, but the <a href="https://github.com/uttiyamaji/ebbp">python port</a> needs some work. Ideally this would be easily available in more languages and SQL engines, along with a similar facility for the mean (and other statistics).</p>
<p>Some other good explanations on these kinds of methods are from <a href="https://kiwidamien.github.io/shrinkage-and-empirical-bayes-to-improve-inference.html">Damien Martin</a> and <a href="http://varianceexplained.org/r/empirical_bayes_baseball/">David Robinson</a> (in fact David has a <a href="https://drob.gumroad.com/l/empirical-bayes">whole book</a> on the subject).</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>