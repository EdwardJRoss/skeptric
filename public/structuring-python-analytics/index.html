<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2021-07-05">

<title>skeptric - Structuing Python Analytics Codebases</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">skeptric</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/EdwardJRoss"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Structuing Python Analytics Codebases</h1>
  <div class="quarto-categories">
    <div class="quarto-category">python</div>
    <div class="quarto-category">data</div>
    <div class="quarto-category">legacy code</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 5, 2021</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>Many analytics codebases consist of a pipeline of steps, doing things like getting data, extracting features, training models and evaluating results and diagnostics. The best way to structure the code isn’t obvious and if you’re having trouble importing files, getting module not found errors or are tinkering with PYTHONPATH it’s likely you haven’t got it right.</p>
<p>A way I’ve seen many data analytics processing pipelines structured is with a series of numbered steps:</p>
<pre><code> src
 ├── 01_fetch_data.py
 ├── 02_extract_data.py
 ├── 03_normalise_data.py</code></pre>
<p>The good thing about this structure is that the steps involved are clear with their order. The bad thing about this is that you can’t easily import these because they start with a number (but it can be done with <a href="https://docs.python.org/3/library/importlib.html">importlib</a>), and they will only work when called from the right directory (otherwise paths will be messed up <a href="https://stackoverflow.com/questions/918154/relative-paths-in-python">without some magic</a>).</p>
<p>Instead I recommend having each of the scripts in a directory with the name of the submodule (e.g.&nbsp;<code>my_pipeline</code>). Then there are a few options on how to orchestrate it:</p>
<ol type="1">
<li>Making the module executable</li>
<li>Creating individual step scripts</li>
<li>Makefile or shell script orchestration</li>
</ol>
<section id="making-the-module-executable" class="level2">
<h2 class="anchored" data-anchor-id="making-the-module-executable">Making the module executable</h2>
<p>If you add a <code>__main__.py</code> (as well as the <code>__init__.py</code>) then you can execute the code in that file by running <code>python -m my_pipeline</code>. You can then import the downstream steps there and set up a CLI library such as <a href="http://docs.pyinvoke.org/en/stable/">Invoke</a>, <a href="https://click.palletsprojects.com/">Click</a>, or <a href="https://typer.tiangolo.com/">Typer</a>.</p>
<pre><code> my_pipeline
 ├── __init__.py
 ├── __main__.py
 ├── fetch_data.py
 ├── extract_data.py
 ├── normalise_data.py</code></pre>
<p>The nice thing about this is you don’t need to worry about paths and imports. It also lets you do more complex orchestration in the <code>__main__.py</code> file, and add other useful utilities that don’t fit into the pipeline metaphor.</p>
<p>Another advantage of this method is you can store paths to intermediate steps in <code>__main__.py</code>. If the <a href="../caching-pipelines">pipeline caches intermediate results</a> in some sort of storage then each step needs to know where the last step put it. This leads to duplication between the steps, or a large configuration file containing all the intermediate locations. Instead we can make the input and output locations arguments in the scripts, and set them all in <code>__main__.py</code>.</p>
<p>Note that all your imports will need to be absolute to the package name, e.g <code>import my_pipeline.fetch</code>.</p>
</section>
<section id="creating-individual-step-scrtips" class="level2">
<h2 class="anchored" data-anchor-id="creating-individual-step-scrtips">Creating individual step scrtips</h2>
<p>If you really like the idea of numbered scripts another way to handle it while having the right module structure is with symlinks. The structure we end up with is like this:</p>
<pre><code> my_pipeline
 ├── __init__.py
 ├── fetch_data.py
 ├── extract_data.py
 ├── normalise_data.py
 scripts
 ├── 01_fetch_data
 ├── 02_extract_data
 ├── 03_normalise_data</code></pre>
<p>The module level at the top level and removing the numbers from the scripts fixes the import and path problems. Each of the scripts is a small shell script that invokes the corresponding step with <code>python -m my_pipeline.{step}</code>.</p>
<p>For example <code>01_fetch_data</code> might look like:</p>
<pre class="shell"><code>#!/bin/sh
/usr/bin/env python -m my_pipeline.fetch_data</code></pre>
<p>This script is then invoked using <code>./scripts/01_fetch_data</code>.</p>
<p>You can invoke any of the individual scripts by passing the path with <code>-m</code>, e.g.&nbsp;<code>python -m my_pipeline.fetch_data</code>. We then put all the scripts to run in a <code>scripts</code> subfolder with the numbers like this:</p>
<p>The drawback with this method is you need a way to deal with the intermediate state.</p>
</section>
<section id="creating-a-makefile-or-shell-script" class="level2">
<h2 class="anchored" data-anchor-id="creating-a-makefile-or-shell-script">Creating a Makefile or shell script</h2>
<p>An alternative to using the <code>__main__.py</code> for orchestration is creating a Makefile or shell script. The benefit of that is it can include functionality like installing a virtual environment or pulling a Docker image to run the Python scripts in (whereas the Python scripts won’t be able to run without the environment). The downside is these languages are a bit more brittle and less flexible than Python, and take more work to be nice to use than something like Typer.</p>
<pre><code> my_pipeline
 ├── __init__.py
 ├── fetch_data.py
 ├── extract_data.py
 ├── normalise_data.py
 Makefile</code></pre>
<p>In this case I’d recommend making the input and output directories command line arguments that can be passed by the Makefile or shell script. It can then run, for example the <code>extract_data</code>, using</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/usr/bin/env</span> python <span class="at">-m</span> my_pipeline.extract_data ./data/01_raw ./data/02_primary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It’s critical you have a good command line interface with help (e.g.&nbsp;like <a href="https://gist.github.com/prwhite/8168133">this for Make</a>) and good parsing. A Makefile has the advantage that it can see if the intermediate dependencies have been built and automatically resolve what needs to be done. However it requires some effort to get the sources and targets right so it works smoothly, and some targets might need to be generated for steps without output (e.g.&nbsp;setting up the environment).</p>
</section>
<section id="making-a-choice" class="level1">
<h1>Making a choice</h1>
<p>These are a few ways to structure your Python analytics pipeline with different tradeoffs. In each of the cases we made a proper submodule where the steps could be separately run, which makes it easier to use the tools without thinking too much about paths. In general there is conflicting advice around Python packaging, for example pypa <a href="https://github.com/pypa/sampleproject">recommends putting the package inside the src/ directory</a>, but others <a href="https://docs.python-guide.org/writing/structure/">recommend against an src/ directory</a> since it makes it easier to run without installing.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>