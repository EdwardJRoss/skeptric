<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2020-12-10">

<title>skeptric - Centroid of Points on the Surface of a Sphere</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">skeptric</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/EdwardJRoss"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Centroid of Points on the Surface of a Sphere</h1>
  <div class="quarto-categories">
    <div class="quarto-category">maths</div>
    <div class="quarto-category">python</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 10, 2020</p>
    </div>
  </div>
    
  </div>
  

</header>

<p>I’ve written a derivation of <a href="https://skeptric.com/centroid-spherical-polygon/">how to find the centroid of a polygon on a sphere</a>. This post shows it explicitly in numerical computations, and also looks at the solution in <a href="http://math.ucsd.edu/~sbuss/ResearchWeb/spheremean/">Spherical Averages and Applications to Spherical Splines and Interpolation, by Buss and Fillmore, <em>ACM Transactions on Graphics</em> 20, 95–126 (2001)</a>. Explicitly coding mathematics is a great exercise; having to concretely represent everything unearthed gaps in my understanding and found errors in both drafts of my derivation and the paper.</p>
<p>Given a set of points on a sphere we’re trying to find the point that minimises the average distance from those points, which we’ll call the centroid (or <a href="https://en.wikipedia.org/wiki/Fr%C3%A9chet_mean">Fréchet mean</a>).</p>
<section id="contents" class="level2">
<h2 class="anchored" data-anchor-id="contents">Contents</h2>
<section id="part-1-calculating-the-centroid" class="level3">
<h3 class="anchored" data-anchor-id="part-1-calculating-the-centroid">Part 1: Calculating the centroid</h3>
<ol type="1">
<li><a href="#coordinate-transformations">Coordinate Transformations</a> between spherical and cartesian coordinates</li>
<li><a href="#creating-random-points-on-the-sphere">Creating Random Points on the Sphere</a> for testing</li>
<li><a href="#geodesic-distance">Geodesic Distance</a> calculations</li>
<li><a href="#measuring-the-centroid">Measuring the Centroid</a> in terms of minimising the geodesic distance</li>
<li><a href="#iteratively-finding-the-minimum">Iteratively Finding the Minimum</a> using a closed form solution</li>
</ol>
</section>
<section id="part-2-implementing-buss-and-filmores-approach" class="level3">
<h3 class="anchored" data-anchor-id="part-2-implementing-buss-and-filmores-approach">Part 2: Implementing Buss and Filmore’s approach</h3>
<ol type="1">
<li><a href="#the-exponential-map-and-its-inverse">The exponential map and its inverse</a> calculated at the North Pole</li>
<li><a href="#rotating-spheres">Rotating spheres</a> to enable moving arbitrary points to the North Pole</li>
<li><a href="#exponential-map-at-any-point">Exponential map at any point</a></li>
<li><a href="#attempting-to-implement-algorithm-a1">Attempting to implement the algorithm</a> (and failing to get it to work)</li>
</ol>
</section>
<section id="part-3-gradient-descent-with-pytorch" class="level3">
<h3 class="anchored" data-anchor-id="part-3-gradient-descent-with-pytorch">Part 3: Gradient Descent with Pytorch</h3>
<ol type="1">
<li><a href="#gradient-descent">Gradient Descent</a></li>
</ol>
</section>
</section>
<section id="part-1-calculating-the-centroid-1" class="level1">
<h1>Part 1: Calculating the centroid</h1>
<section id="coordinate-transformations" class="level2">
<h2 class="anchored" data-anchor-id="coordinate-transformations">Coordinate transformations</h2>
<p>To do calculations on the unit sphere we’ll need some way of representing points on the sphere. There’s lots of possible representations (I normally like <a href="https://en.wikipedia.org/wiki/Stereographic_projection">Stereographic Projections</a>), but we’ll stick to two:</p>
<ul>
<li>Euclidean coordinate representation: (x,y,z) coordinates in 3-dimensional space.</li>
<li>Latitude Longitude representation of places on a sphere.</li>
</ul>
<p>To convert a latitude, from -π/2 to π/2 radians (i.e.&nbsp;90°S to 90°N), and a longitude, from -π to π radians (i.e.&nbsp;180°W to 180°E) to a coordinate we can use the following formula (<a href="https://en.wikipedia.org/wiki/Spherical_coordinate_system#Cartesian_coordinates">see Wikipedia for the Geometry</a>)</p>
<p><img src="../images/spherical_coords.png" class="img-fluid"></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> latlon_to_coord(lat, lon):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array([cos(lat) <span class="op">*</span> cos(lon), cos(lat)<span class="op">*</span>sin(lon), sin(lat)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="sanity-checking-coordinates" class="level3">
<h3 class="anchored" data-anchor-id="sanity-checking-coordinates">Sanity checking coordinates</h3>
<p>Let’s make sure this gives reasonable results simple angles</p>
<p>So the north pole, (0,0,1) should be at π/2 latitude</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>latlon_to_coord(pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([6.123234e-17, 0.000000e+00, 1.000000e+00])</code></pre>
<p>And the south pole, (0,0,-1), at -π/2 latitude</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>latlon_to_coord(<span class="op">-</span>pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([ 6.123234e-17,  0.000000e+00, -1.000000e+00])</code></pre>
<p>And the point on the x-axis (1,0,0) is at 0 latitude, and by convention 0 longitude</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>latlon_to_coord(<span class="dv">0</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1., 0., 0.])</code></pre>
<p>The y-axis is at π/2 longitude</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>latlon_to_coord(<span class="dv">0</span>, pi<span class="op">/</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([6.123234e-17, 1.000000e+00, 0.000000e+00])</code></pre>
<p>And at π longitude we have the other side of the x axis</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>latlon_to_coord(<span class="dv">0</span>, pi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-1.0000000e+00,  1.2246468e-16,  0.0000000e+00])</code></pre>
<p>Finally at π/4 longitude we should always have the x and y components equal</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>latlon_to_coord(<span class="dv">0</span>, pi<span class="op">/</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.70710678, 0.70710678, 0.        ])</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>latlon_to_coord(pi<span class="op">/</span><span class="dv">4</span>, pi<span class="op">/</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.5       , 0.5       , 0.70710678])</code></pre>
</section>
<section id="inverse-transformation-cartesian-coordinates-to-latitude-and-longitude" class="level3">
<h3 class="anchored" data-anchor-id="inverse-transformation-cartesian-coordinates-to-latitude-and-longitude">Inverse Transformation: Cartesian Coordinates to Latitude and Longitude</h3>
<p>Notice the use of <a href="https://en.wikipedia.org/wiki/Atan2">atan2</a> to get the sign right.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> coord_to_latlon(x, y, z):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> np.<span class="bu">all</span>(np.<span class="bu">abs</span>((x<span class="op">*</span>x <span class="op">+</span>y<span class="op">*</span>y <span class="op">+</span>z<span class="op">*</span>z) <span class="op">-</span> <span class="dv">1</span>) <span class="op">&lt;</span> <span class="fl">1e-5</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    lat <span class="op">=</span> arcsin(z)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    lon <span class="op">=</span> arctan2(y, x)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array([lat, lon])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="sanity-checking-coordinates-1" class="level3">
<h3 class="anchored" data-anchor-id="sanity-checking-coordinates-1">Sanity checking coordinates</h3>
<p>Let’s check the inverse of some of the examples above</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>coord_to_latlon(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1.57079633, 0.        ])</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>coord_to_latlon(<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-1.57079633,  0.        ])</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>coord_to_latlon(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0., 0.])</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>coord_to_latlon(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.        , 1.57079633])</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>coord_to_latlon(<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([ 0.        , -1.57079633])</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>coord_to_latlon(<span class="op">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.        , 3.14159265])</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>coord_to_latlon(<span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>),<span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>),<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.        , 0.78539816])</code></pre>
</section>
</section>
<section id="creating-random-points-on-the-sphere" class="level2">
<h2 class="anchored" data-anchor-id="creating-random-points-on-the-sphere">Creating Random Points on the Sphere</h2>
<p>For testing it’s useful to be able to create random points on the sphere. In this case I don’t really care about the distribtution of the points so I will always just use a random uniform function.</p>
<p>I choose the coordinates as the first axis, and the points lie along the second axis. Either choice leads to awkwardness in places either in index access or broadcasting.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_latlon(n):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (np.random.random_sample([<span class="dv">2</span>, n]) <span class="op">-</span> <span class="fl">0.5</span>) <span class="op">*</span> np.array([pi, <span class="dv">2</span><span class="op">*</span>pi])[...,<span class="va">None</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here are 5 points of latitude/longitude (the lat/lon is read vertically in the array below).</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>random_latlon(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[-1.05051377,  1.51919682,  1.08064898, -0.9478646 , -0.24458294],
       [ 0.51328911, -0.2909267 ,  0.70478098, -0.09613048, -1.45489469]])</code></pre>
<p>The points are definitely in the right coordinate ranges; latitude between -pi/2 to pi/2 and longiture from -pi to pi</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> random_latlon(<span class="dv">300</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>r.<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>), r.<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-1.56325868, -3.10261397]), array([1.56479825, 3.11079206]))</code></pre>
<div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(r[<span class="dv">0</span>], r[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>&lt;matplotlib.collections.PathCollection at 0x7f9b414786d0&gt;</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../post/calculate-centroid-on-sphere/output_38_1.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">png</figcaption><p></p>
</figure>
</div>
<p>Similarly we can create a random point on the sphere by making a random point in the 3 dimensional unit cube centred on the origin and projecting it. Note this will have a different distribution to the latitude longitude random points.</p>
<p>There is an infinitessimal chance this will blow up if we pick (0,0,0) as the random point.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_sphere_point(n):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">=</span> np.random.random_sample([<span class="dv">3</span>, n]) <span class="op">-</span> <span class="fl">0.5</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    norm <span class="op">=</span> np.sqrt((ans<span class="op">*</span>ans).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans <span class="op">/</span> norm[...,:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here are 5 points on the sphere in Cartesian Coordinates</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>random_sphere_point(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[-0.7474551 , -0.67828974,  0.4894528 ,  0.14031347, -0.83906874],
       [ 0.12810391, -0.73422057,  0.46630495,  0.00811564,  0.15397168],
       [-0.65184374, -0.02903757,  0.73688239,  0.99007387, -0.52178191]])</code></pre>
<p>Check they actually do lie on the unit sphere - a distance of 1 from the origin.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> random_sphere_point(<span class="dv">1000</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>norms <span class="op">=</span> (r<span class="op">*</span>r).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>norms.<span class="bu">max</span>(), norms.<span class="bu">min</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(1.0000000000000004, 0.9999999999999996)</code></pre>
<p>I guess that looks like a sphere</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> plt.figure()</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> plt.axes(projection<span class="op">=</span><span class="st">'3d'</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>ax.scatter3D(<span class="op">*</span>r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>&lt;mpl_toolkits.mplot3d.art3d.Path3DCollection at 0x7f9b3f343b80&gt;</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../post/calculate-centroid-on-sphere/output_46_1.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">png</figcaption><p></p>
</figure>
</div>
<p>If we turn it a bit it still looks like a sphere</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>ax.view_init(<span class="dv">45</span>, <span class="dv">45</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../post/calculate-centroid-on-sphere/output_48_0.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">png</figcaption><p></p>
</figure>
</div>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>ax.view_init(<span class="dv">165</span>, <span class="dv">135</span>)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../post/calculate-centroid-on-sphere/output_49_0.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">png</figcaption><p></p>
</figure>
</div>
<p>We can also project it back to lat-lon.</p>
<p>Notice how it’s more concentrated towards the centre because there’s actually less area in the extremites of latitude and longiture.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(<span class="op">*</span>coord_to_latlon(<span class="op">*</span>r))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>&lt;matplotlib.collections.PathCollection at 0x7f9b3f327370&gt;</code></pre>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../post/calculate-centroid-on-sphere/output_51_1.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">png</figcaption><p></p>
</figure>
</div>
<p>Now let’s check that our coordinate transforms are actually inverses by checking a bunch of random points.</p>
<p>It looks like the coordinate transforms are really inverses</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> distance(x, y, axis<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sqrt((np.power(x <span class="op">-</span> y, <span class="dv">2</span>)).<span class="bu">sum</span>(axis<span class="op">=</span>axis))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> random_latlon(<span class="dv">1000</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>rr <span class="op">=</span> coord_to_latlon(<span class="op">*</span>latlon_to_coord(<span class="op">*</span>r))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>distance(rr, r).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>5.484501741648273e-14</code></pre>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> random_sphere_point(<span class="dv">1000</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>rr <span class="op">=</span> latlon_to_coord(<span class="op">*</span>coord_to_latlon(<span class="op">*</span>r))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>distance(rr, r).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.3087313122991207e-15</code></pre>
</section>
<section id="geodesic-distance" class="level2">
<h2 class="anchored" data-anchor-id="geodesic-distance">Geodesic Distance</h2>
<p>I claim that the geodesic distance of two points on a sphere is the arccos of the dot product of the vectors that make them.</p>
<p><a href="https://en.wikipedia.org/wiki/Great-circle_distance">According to Wikipedia</a> the distance between two points is:</p>
<p><span class="math display">\[\Delta\sigma = \arccos\bigl(\sin\phi_1\sin\phi_2 + \cos\phi_1\cos\phi_2\cos(\Delta\lambda)\bigr).\]</span></p>
<p>Where <span class="math inline">\(\lambda_1, \phi_1\) and \(\lambda_2, \phi_2\)</span> are the longitude and latitude respectively.</p>
<p>Although this is numerically unstable let’s check this to see if we’re in the right ballpark</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> random_latlon(<span class="dv">10</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> random_latlon(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> latlon_geodist(lat1, lon1, lat2, lon2):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  arccos(sin(lat1) <span class="op">*</span> sin(lat2) <span class="op">+</span> cos(lat1) <span class="op">*</span> cos(lat2) <span class="op">*</span> cos(lon2 <span class="op">-</span> lon1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s do some sanity checking</p>
<p>Points at the same place should be 0 distance</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>latlon_geodist(lat1, lon1, lat1, lon1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>&lt;ipython-input-34-30a781f9625f&gt;:2: RuntimeWarning: invalid value encountered in arccos
  return  arccos(sin(lat1) * sin(lat2) + cos(lat1) * cos(lat2) * cos(lon2 - lon1))





array([0.00000000e+00, 1.49011612e-08, 0.00000000e+00, 0.00000000e+00,
       0.00000000e+00, 0.00000000e+00, 0.00000000e+00,            nan,
       0.00000000e+00, 0.00000000e+00])</code></pre>
<p>It’s possible to get a nan due to floating point error. This rounds up to just over 1 which is just outside the bounds of arccos.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>lat, lon <span class="op">=</span> (<span class="op">-</span><span class="fl">1.129680862943046</span>, <span class="op">-</span><span class="fl">1.4351343458834227</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>sin(lat) <span class="op">*</span> sin(lat) <span class="op">+</span> cos(lat) <span class="op">*</span> cos(lat) <span class="op">*</span> cos(lon <span class="op">-</span> lon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.0000000000000002</code></pre>
<p>Let’s hack this a little to make it more stable</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> latlon_geodist(lat1, lon1, lat2, lon2, eps <span class="op">=</span> <span class="fl">1e-6</span>):</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    dotprod <span class="op">=</span> sin(lat1) <span class="op">*</span> sin(lat2) <span class="op">+</span> cos(lat1) <span class="op">*</span> cos(lat2) <span class="op">*</span> cos(lon2 <span class="op">-</span> lon1)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> ((<span class="op">-</span><span class="dv">1</span> <span class="op">-</span> eps) <span class="op">&lt;=</span> dotprod).<span class="bu">all</span>() <span class="kw">and</span> (dotprod <span class="op">&lt;=</span> (<span class="dv">1</span> <span class="op">+</span> eps)).<span class="bu">all</span>()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    dotprod <span class="op">=</span> dotprod.clip(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arccos(dotprod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>latlon_geodist(lat, lon, lat, lon)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.0</code></pre>
<p>The distance between the equator and the north pole should be pi/2</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>latlon_geodist(<span class="dv">0</span>, <span class="dv">0</span>, pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.5707963267948966</code></pre>
<p>The distance between antipodal points should be pi</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>latlon_geodist(<span class="op">-</span>pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>, pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>3.141592653589793</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>latlon_geodist(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, pi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>3.141592653589793</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>latlon_geodist(<span class="dv">0</span>, <span class="op">-</span>pi<span class="op">/</span><span class="dv">2</span>, <span class="dv">0</span>, pi<span class="op">/</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>3.141592653589793</code></pre>
<p>Now compare the geodistance with the arccos of the dot product</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> latlon_geodist(lat1, lon1, lat2, lon2)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>dist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([2.46947963, 2.49913914, 1.46664046, 1.17041288, 0.37746113,
       2.16346273, 1.00909388, 0.48192531, 2.53874702, 2.6748886 ])</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> latlon_to_coord(lat1, lon1)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> latlon_to_coord(lat2, lon2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>dist2 <span class="op">=</span> arccos((p<span class="op">*</span>q).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>dist2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([2.46947963, 2.49913914, 1.46664046, 1.17041288, 0.37746113,
       2.16346273, 1.00909388, 0.48192531, 2.53874702, 2.6748886 ])</code></pre>
<p>They agree to the order of floating point error.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>(dist <span class="op">-</span> dist2).<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.0</code></pre>
<p>Let’s capture that in a function, again making sure to bound the elements to deal with floating point errors.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> geodist(x, y, eps<span class="op">=</span><span class="fl">1e-6</span>):</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    dotprod <span class="op">=</span> y.T <span class="op">@</span> x</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> ((<span class="op">-</span><span class="dv">1</span> <span class="op">-</span> eps) <span class="op">&lt;=</span> dotprod).<span class="bu">all</span>() <span class="kw">and</span> (dotprod <span class="op">&lt;=</span> (<span class="dv">1</span> <span class="op">+</span> eps)).<span class="bu">all</span>()</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    dotprod <span class="op">=</span> dotprod.clip(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.arccos(dotprod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>[geodist(pi, qi) <span class="cf">for</span> pi, qi <span class="kw">in</span> <span class="bu">zip</span>(p.T, q.T)] <span class="op">-</span> dist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0.])</code></pre>
<p>In our function x can also be a collection of points:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>q0 <span class="op">=</span> np.array(q)[:,<span class="dv">0</span>]</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>q0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([ 0.31287334, -0.20532369, -0.92733622])</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>[geodist(pi, q0) <span class="cf">for</span> pi <span class="kw">in</span> p.T]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>[2.469479630515192,
 0.40323027521610894,
 1.4920173306523,
 1.9558900601514497,
 2.7359590483860647,
 2.1462847027999032,
 0.7043405473704512,
 2.7367906455922415,
 0.9539342223012038,
 1.2027484136227085]</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>geodist(p, q0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([2.46947963, 0.40323028, 1.49201733, 1.95589006, 2.73595905,
       2.1462847 , 0.70434055, 2.73679065, 0.95393422, 1.20274841])</code></pre>
<p>They can also both be arrays in which case all pairing are calculated.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>geodist(p, q)[:,<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([2.46947963, 0.34759067, 2.38907755, 0.89968604, 0.26041626,
       2.60671514, 1.83068643, 0.26215902, 1.62594305, 0.35150679])</code></pre>
</section>
<section id="measuring-the-centroid" class="level2">
<h2 class="anchored" data-anchor-id="measuring-the-centroid">Measuring the Centroid</h2>
<p>Suppose we have a bunch of points on the sphere, the centroid is the point that minimises the total (or equivalently average) distance from that point to all other points.</p>
<p>Let’s try to find the centroid of 4 points.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> random_sphere_point(<span class="dv">1</span>)[:,<span class="dv">0</span>]</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> random_sphere_point(<span class="dv">4</span>)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>m, ps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([ 0.61804667, -0.76357346, -0.18701308]),
 array([[ 0.93870158, -0.44268846,  0.68158944, -0.79466137],
        [-0.3443822 , -0.70496228,  0.34836305, -0.04389649],
        [ 0.01549958,  0.55412554,  0.64348973, -0.60546379]]))</code></pre>
<div class="sourceCode" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>dists <span class="op">=</span> geodist(ps, m)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>dists</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.57310037, 1.40903212, 1.53587692, 1.92238526])</code></pre>
<div class="sourceCode" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>dists.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.3600986701826971</code></pre>
<div class="sourceCode" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>lats, lons <span class="op">=</span> coord_to_latlon(<span class="op">*</span>ps)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>mlat, mlon <span class="op">=</span> coord_to_latlon(<span class="op">*</span>m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>dists2 <span class="op">=</span> latlon_geodist(lats, lons, mlat, mlon)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>dists2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.57310037, 1.40903212, 1.53587692, 1.92238526])</code></pre>
<div class="sourceCode" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>dists2.mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.3600986701826971</code></pre>
<p>The centroid minimises average distance.</p>
<p>We’ll create a function that takes a collection of potential centroids to calculate the average distance from.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>m[:,<span class="va">None</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[ 0.61804667],
       [-0.76357346],
       [-0.18701308]])</code></pre>
<div class="sourceCode" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>m.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(3,)</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>ps.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(3, 4)</code></pre>
<div class="sourceCode" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> avg_distance(ps, m):</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Allow m to be a vector *or* a matrix</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(m.shape) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>        m <span class="op">=</span> m[:, <span class="va">None</span>]</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> geodist(ps, m).mean(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1.36009867])</code></pre>
<p>Let’s do a random search for the centroid of the ps</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> random_sphere_point(<span class="dv">50000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>distances <span class="op">=</span> avg_distance(ps, m)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>distances</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1.87538182, 1.72981518, 1.83908373, ..., 1.53442742, 1.54397244,
       1.64161356])</code></pre>
<p>Clearly the minimum <em>must</em> be lower than this.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>m[:,distances.argmin()], distances.<span class="bu">min</span>(), distances.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-0.43100664, -0.70535782,  0.56276427]),
 1.2565096068989563,
 1.8852477691126441)</code></pre>
<p>Let’s just check it’s on the unit sphere.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>min_point <span class="op">=</span> m[:,distances.argmin()]</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>(min_point <span class="op">*</span> min_point).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.9999999999999998</code></pre>
<p>In <a href="https://notionparallax.co.uk/2009/centroid-of-points-on-the-surface-of-a-sphere">the notion parallax article</a> the second suggestion is to project the average vector (which he says doesn’t seem quite right).</p>
<p>We can check this explicity by calculating that projection.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>avg <span class="op">=</span> ps.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>avg <span class="op">=</span> avg <span class="op">/</span> np.sqrt((avg<span class="op">*</span>avg).<span class="bu">sum</span>())</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>meanpoint_dist <span class="op">=</span> avg_distance(ps, avg[:,<span class="va">None</span>])</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>avg, meanpoint_dist, meanpoint_dist <span class="op">&lt;=</span> distances.<span class="bu">min</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([ 0.37007754, -0.7198562 ,  0.58723902]),
 array([1.29459946]),
 array([False]))</code></pre>
</section>
<section id="iteratively-finding-the-minimum" class="level2">
<h2 class="anchored" data-anchor-id="iteratively-finding-the-minimum">Iteratively finding the minimum</h2>
<p>As I derived in <a href="../centroid-spherical-polygon">finding the Centroid of a Spherical Polygon</a> it occurs where</p>
<p><span class="math display">\[c = k \sum_{i=1}^{N} \frac{p_i}{\sqrt{1 - (c \cdot p_i)^2}}\]</span></p>
<p>We can evaluate this iteratively and hope that it converges to the minimum.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> improve_centroid(c, ps):</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>    ans <span class="op">=</span> (ps <span class="op">/</span> sqrt(<span class="dv">1</span> <span class="op">-</span> np.power(c<span class="op">@</span>ps, <span class="dv">2</span>))).<span class="bu">sum</span>(axis<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    norm <span class="op">=</span> sqrt(ans <span class="op">@</span> ans)</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ans <span class="op">/</span> norm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>improve_centroid(avg, ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([ 0.23688037, -0.81413966,  0.53015498])</code></pre>
<div class="sourceCode" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fixpoint(f, x0, eps<span class="op">=</span><span class="fl">1e-5</span>, maxiter<span class="op">=</span><span class="dv">1000</span>, <span class="op">**</span>kwargs):</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(maxiter):</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> f(x0, <span class="op">**</span>kwargs)</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> distance(x, x0) <span class="op">&lt;</span> eps:</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> x</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>        x0 <span class="op">=</span> x</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Did not converge"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spherical_centroid(ps, eps<span class="op">=</span><span class="fl">1e-5</span>, maxiter<span class="op">=</span><span class="dv">10000</span>):</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fixpoint(improve_centroid, np.zeros((<span class="dv">3</span>,)), ps<span class="op">=</span>ps, eps<span class="op">=</span>eps, maxiter<span class="op">=</span>maxiter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>fix <span class="op">=</span> spherical_centroid(ps)</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>fix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.442657  , -0.70497373,  0.5541361 ])</code></pre>
<p>This does seem to be lower than any of our random points</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>dmin <span class="op">=</span> avg_distance(ps, fix)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>dmin, dmin <span class="op">&lt;=</span> distances.<span class="bu">min</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([1.2554998]), array([ True]))</code></pre>
<p>Another good check is to see whether moving a small distance around this point increases the distance.</p>
<p>(Note the small distance needs to be a bit bigger than our eps above in deciding convergence)</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>fix_latlon <span class="op">=</span> coord_to_latlon(<span class="op">*</span>fix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>eps <span class="op">=</span> <span class="fl">1e-4</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>xeps <span class="op">=</span> np.array([eps, <span class="dv">0</span>])</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>yeps <span class="op">=</span> np.array([<span class="dv">0</span>, eps])</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>perturbations <span class="op">=</span> np.array([latlon_to_coord(<span class="op">*</span>(fix_latlon <span class="op">+</span> x)) <span class="cf">for</span> x <span class="kw">in</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>                  [<span class="dv">0</span>, xeps, <span class="op">-</span>xeps, yeps, <span class="op">-</span>yeps]]).T</span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>perturbations</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[-0.442657  , -0.44262753, -0.44268646, -0.4425865 , -0.44272749],
       [-0.70497373, -0.7049268 , -0.70502066, -0.705018  , -0.70492947],
       [ 0.5541361 ,  0.55421934,  0.55405286,  0.5541361 ,  0.5541361 ]])</code></pre>
<p>The minimum occurs at the first point, with no perturbation.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, perturbations)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1.2554998 , 1.25551318, 1.2555215 , 1.25550478, 1.25551945])</code></pre>
<div class="sourceCode" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, perturbations).argmin()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0</code></pre>
</section>
</section>
<section id="part-2-recreating-buss-and-filmores-approach" class="level1">
<h1>Part 2: Recreating Buss and Filmore’s Approach</h1>
<section id="the-exponential-map-and-its-inverse" class="level2">
<h2 class="anchored" data-anchor-id="the-exponential-map-and-its-inverse">The exponential map and its inverse</h2>
<p>In the Buss and Filmore paper they talk about the exponential map and its inverse at the point (0,0,1). The idea is that we are building a correspondence between moving in the tangent plane and moving in the sphere itself in a way that preserves distances. Really this is just a special sort of parameterisation of the sphere that preserves distances.</p>
<p><img src="../images/sphere_tangent_plane.png" class="img-fluid"></p>
<p>The exponential map from the north pole takes an (x,y) point on that plane and returns an (x,y,z) coordinate on the sphere’s surface.</p>
<p>They give the formula (bottom of page 11):</p>
<p><span class="math display">\[\exp_{(0,0,1)} (x, y) = (x \frac{\sin r}{r}, y \frac{\sin r}{r}, \cos{r})\]</span></p>
<p>Where <span class="math inline">\(r = \sqrt{x^2 + y^2}\)</span> is the distance of the point on the tangent plane from where it touches the sphere.</p>
<p>In code (using sinc for numerical stability at 0)</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exp_northpole(x, y):</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> sqrt(x<span class="op">*</span>x <span class="op">+</span> y<span class="op">*</span>y)</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>    sincr <span class="op">=</span> sinc(r<span class="op">/</span>np.pi)</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (x <span class="op">*</span> sincr, y <span class="op">*</span> sincr, cos(r))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So at the origin we should get the north pole</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>exp_northpole(<span class="dv">0</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.0, 0.0, 1.0)</code></pre>
<p>And if we move forward a bit in the x direction on the tangent plane we move along the x-axis in 3 space the same distance.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> np.array([<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> exp_northpole(<span class="fl">0.5</span>,<span class="dv">0</span>)</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>p, geodist(p, q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>((0.479425538604203, 0.0, 0.8775825618903728), 0.4999999999999999)</code></pre>
<p>And similar for the y-axis</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> np.array([<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> exp_northpole(<span class="fl">0.0</span>,<span class="fl">0.3</span>)</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>p, geodist(p, q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>((0.0, 0.29552020666133955, 0.955336489125606), 0.30000000000000016)</code></pre>
<p>And if we move (0.3, -0.4) which by Pythagoras is a distance of 0.5</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> np.array([<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>])</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> exp_northpole(<span class="fl">0.3</span>,<span class="op">-</span><span class="fl">0.4</span>)</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>p, geodist(p, q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>((0.2876553231625218, -0.3835404308833624, 0.8775825618903728),
 0.4999999999999999)</code></pre>
<p>Notice that we can wrap around the sphere</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>exp_northpole(<span class="dv">0</span>, np.pi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.0, 1.2246467991473532e-16, -1.0)</code></pre>
<div class="sourceCode" id="cb146"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>exp_northpole(<span class="dv">0</span>, <span class="dv">2</span><span class="op">*</span>np.pi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(-0.0, -2.4492935982947064e-16, 1.0)</code></pre>
<div class="sourceCode" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>exp_northpole(<span class="dv">0</span>, <span class="dv">4</span><span class="op">*</span>np.pi)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(-0.0, -4.898587196589413e-16, 1.0)</code></pre>
<section id="the-inverse-of-the-exponential-map" class="level3">
<h3 class="anchored" data-anchor-id="the-inverse-of-the-exponential-map">The inverse of the exponential map</h3>
<p>It’s easy to calculate the inverse of the exponential map at the north pole, which they call l (for log), and they have the formula on page 12:</p>
<p><span class="math display">\[l_{(0,0,1)}(x, y, z) = \left(x \frac{\theta}{\sin(\theta)}, y \frac{\theta}{\sin(\theta)}\right)\]</span></p>
<p>Where <span class="math inline">\(\theta = \cos^{-1}(z)\)</span>.</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_northpole(x, y, z):</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> arccos(z)</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    sinc_theta <span class="op">=</span> sinc(theta <span class="op">/</span> np.pi)</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (x <span class="op">/</span> sinc_theta, y<span class="op">/</span> sinc_theta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>First we should see the north pole itself should map to the origin</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>log_northpole(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.0, 0.0)</code></pre>
<p>We can check a few points and that distances are preserved, e.g.&nbsp;the equator is a distance pi/2 away</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>log_northpole(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.0, 1.5707963267948966)</code></pre>
<div class="sourceCode" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>log_northpole(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(1.5707963267948966, 0.0)</code></pre>
<p>And this point is pi/4 from the north pole</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>log_northpole(<span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>),<span class="dv">0</span>,<span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.7853981633974483, 0.0)</code></pre>
<p>The mapping fails at the south pole (because the exponential map can’t make it there). This should actually be the point at infinity.</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>log_northpole(<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.0, 0.0)</code></pre>
<p>But it should be a real inverse:</p>
<p>If we take points on the sphere they should go back to where they started</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> random_sphere_point(<span class="dv">5</span>)</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>distance(ps, exp_northpole(<span class="op">*</span>log_northpole(<span class="op">*</span>ps)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([2.02487339e-15, 1.02967200e-15, 5.55111512e-17, 0.00000000e+00,
       0.00000000e+00])</code></pre>
<p>Now the inverse will only work if we don’t wrap around the sphere; that is we need to move less than pi in any direction.</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>npoint <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>length <span class="op">=</span> np.random.random(npoint) <span class="op">*</span> pi</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.random.random(npoint) <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span> pi</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>xs, ys <span class="op">=</span> length <span class="op">*</span> cos(direction), length <span class="op">*</span> sin(direction)</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>ts <span class="op">=</span> np.array([xs, ys])</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>ts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[-0.04616066, -0.17607737,  0.53101022, -0.07972639,  0.45558742],
       [ 0.13898508, -0.86137675, -2.0428374 , -3.04819971,  1.10504611]])</code></pre>
<div class="sourceCode" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>distance(ts, log_northpole(<span class="op">*</span>exp_northpole(<span class="op">*</span>ts)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 1.46600946e-14,
       0.00000000e+00])</code></pre>
</section>
</section>
<section id="rotating-spheres" class="level2">
<h2 class="anchored" data-anchor-id="rotating-spheres">Rotating Spheres</h2>
<p>The paper doesn’t have a formula for the exponential map and its inverse at other points, but we can work it out by rotating the sphere and then rotating it back. This is inefficient, but gets us the right answer.</p>
<p>First we need a way of rotating the sphere. This is <a href="https://en.wikipedia.org/wiki/Rotation_matrix">surpisingly complicated</a>, but given an axis represented by unit vector u and an angle theta we can do a rotation with the following matrix:</p>
<p><span class="math display">\[R = \begin{bmatrix}
\cos \theta +u_x^2 \left(1-\cos \theta\right) &amp; u_x u_y \left(1-\cos \theta\right) - u_z \sin \theta &amp; u_x u_z \left(1-\cos \theta\right) + u_y \sin \theta \\
u_y u_x \left(1-\cos \theta\right) + u_z \sin \theta &amp; \cos \theta + u_y^2\left(1-\cos \theta\right) &amp; u_y u_z \left(1-\cos \theta\right) - u_x \sin \theta \\
u_z u_x \left(1-\cos \theta\right) - u_y \sin \theta &amp; u_z u_y \left(1-\cos \theta\right) + u_x \sin \theta &amp; \cos \theta + u_z^2\left(1-\cos \theta\right)
\end{bmatrix}\]</span></p>
<div class="sourceCode" id="cb167"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rot_matrix(u, t):</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>    ux, uy, uz <span class="op">=</span> u</span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>    cost <span class="op">=</span> cos(t)</span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>    sint <span class="op">=</span> sin(t)</span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.array([</span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a> [cost<span class="op">+</span>ux<span class="op">*</span>ux<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost), ux<span class="op">*</span>uy<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost)<span class="op">-</span>uz<span class="op">*</span>sint, ux<span class="op">*</span>uz<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost)<span class="op">+</span>uy<span class="op">*</span>sint],</span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a> [uy<span class="op">*</span>ux<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost)<span class="op">+</span>uz<span class="op">*</span>sint, cost<span class="op">+</span>uy<span class="op">*</span>uy<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost), uy<span class="op">*</span>uz<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost)<span class="op">-</span>ux<span class="op">*</span>sint],</span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a> [uz<span class="op">*</span>ux<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost)<span class="op">-</span>uy<span class="op">*</span>sint, uz<span class="op">*</span>uy<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost)<span class="op">+</span>ux<span class="op">*</span>sint, cost<span class="op">+</span>uz<span class="op">*</span>uz<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>cost)],</span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>    ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Sanity checking: A rotation of 0 should be identity</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>rot_matrix(random_sphere_point(<span class="dv">1</span>)[:,<span class="dv">0</span>],<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[ 1., -0.,  0.],
       [ 0.,  1., -0.],
       [ 0.,  0.,  1.]])</code></pre>
<p>A rotation about the z-axis should be in the xy-plane</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>rot_matrix((<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>), pi<span class="op">/</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[ 0.8660254, -0.5      ,  0.       ],
       [ 0.5      ,  0.8660254,  0.       ],
       [ 0.       ,  0.       ,  1.       ]])</code></pre>
<p>And reversing the axis should reverse the rotation</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>rot_matrix((<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>), pi<span class="op">/</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[ 0.8660254,  0.5      ,  0.       ],
       [-0.5      ,  0.8660254,  0.       ],
       [ 0.       ,  0.       ,  1.       ]])</code></pre>
<p>And similarly a rotation about the x-axis should be in the y-z plane</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>rot_matrix((<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>), pi<span class="op">/</span><span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[ 1.       ,  0.       ,  0.       ],
       [ 0.       ,  0.8660254, -0.5      ],
       [ 0.       ,  0.5      ,  0.8660254]])</code></pre>
<p>Let’s check a random rotation</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a>axis <span class="op">=</span> random_sphere_point(<span class="dv">1</span>)[:,<span class="dv">0</span>]</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>angle <span class="op">=</span> np.random.random_sample(<span class="dv">1</span>)[<span class="dv">0</span>] <span class="op">*</span> pi</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>axis, angle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([ 0.39320147, -0.03521715,  0.91877764]), 0.8930289746904281)</code></pre>
<div class="sourceCode" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> rot_matrix(axis, angle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Rotating the oposite way should invert it</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>Rinv <span class="op">=</span> rot_matrix(axis, <span class="op">-</span>angle)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This should be the identity matrix</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>R <span class="op">@</span> Rinv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[ 1.00000000e+00,  2.28238442e-17, -2.96906906e-17],
       [ 2.28238442e-17,  1.00000000e+00, -3.30265999e-17],
       [-2.96906906e-17, -3.30265999e-17,  1.00000000e+00]])</code></pre>
<div class="sourceCode" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>Rinv <span class="op">@</span> R</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[ 1.00000000e+00,  9.75220593e-17, -7.54846245e-17],
       [ 9.75220593e-17,  1.00000000e+00, -3.69276604e-17],
       [-7.54846245e-17, -3.69276604e-17,  1.00000000e+00]])</code></pre>
<p>Let’s rotate some random points and check if it preserves distances</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>p1, p2 <span class="op">=</span> random_sphere_point(<span class="dv">2</span>).T</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>p1, p2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([ 0.84651763, -0.45095389, -0.2829284 ]),
 array([ 0.07670365, -0.73056703, -0.67851925]))</code></pre>
<div class="sourceCode" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>geodist(p1, p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.944244049404823</code></pre>
<div class="sourceCode" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>geodist(R<span class="op">@</span>p1, R<span class="op">@</span>p2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.9442440494048231</code></pre>
<section id="rotating-to-the-north-pole" class="level3">
<h3 class="anchored" data-anchor-id="rotating-to-the-north-pole">Rotating to the north pole</h3>
<p>If we want to rotate a point to the north pole we can:</p>
<ol type="1">
<li>Find the plane containing the centre of the sphere, the point and the north pole</li>
<li>Find an axis perpendicular to that plane</li>
<li>Calculate the angle between the sphere and the point</li>
<li>Rotate along that axis by that angle (being careful about orientation)</li>
</ol>
<p>There’s an easy way to calculate the perpendicular axis to two vectors in 3 dimensions; the <a href="https://en.wikipedia.org/wiki/Cross_product">cross product</a> (or for differential geometers the <a href="https://en.wikipedia.org/wiki/Cross_product#Cross_product_as_an_external_product">hodge dual of the wedge product</a>).</p>
<p>I always remember the definition of the cross product by the mnemonic <code>xyzxyz</code>; e.g.&nbsp;the first xyz tells us the x component is yz-zy, then we go a letter across to yzx and so the y component is zx-xz and finally for the z component.</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cross_product(u, v):</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>    ux,uy,uz <span class="op">=</span> u</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>    vx,vy,vz <span class="op">=</span> v</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (uy<span class="op">*</span>vz<span class="op">-</span>uz<span class="op">*</span>vy, uz<span class="op">*</span>vx<span class="op">-</span>ux<span class="op">*</span>vz, ux<span class="op">*</span>vy <span class="op">-</span> uy<span class="op">*</span>vx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s check a <a href="https://www.mathsisfun.com/algebra/vectors-cross-product.html">random example</a>:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>cross_product((<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>) , (<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(-3, 6, -3)</code></pre>
<p>Now we can use this to calculate a unit perpendicular vector</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> norm(x, axis<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.sqrt((x<span class="op">*</span>x).<span class="bu">sum</span>(axis<span class="op">=</span>axis))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb194"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> unit_perp(u, v):</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.array(cross_product(u, v))</span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> v <span class="op">/</span> norm(v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>unit_perp((<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>) , (<span class="dv">5</span>,<span class="dv">6</span>,<span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.40824829,  0.81649658, -0.40824829])</code></pre>
<div class="sourceCode" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>north_pole <span class="op">=</span> np.array((<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb198"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> perp_to_north_pole(v):</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Special handling for north/south pole here</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note the order is important for orientation</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> unit_perp(v, north_pole)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>perp_to_north_pole((<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([ 0., -1.,  0.])</code></pre>
<div class="sourceCode" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>perp_to_north_pole((<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1., 0., 0.])</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>perp_to_north_pole((<span class="dv">0</span>,<span class="dv">1</span><span class="op">/</span>np.sqrt(<span class="dv">2</span>),<span class="dv">1</span><span class="op">/</span>np.sqrt(<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1., 0., 0.])</code></pre>
<p>Of course this will all explode if the two vectors are parallel (since then there’s a whole plane of potential orthogonal vectors, you need to break the symmetry).</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>perp_to_north_pole((<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)), perp_to_north_pole((<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>&lt;ipython-input-112-372364f14156&gt;:3: RuntimeWarning: invalid value encountered in true_divide
  return v / norm(v)





(array([nan, nan, nan]), array([nan, nan, nan]))</code></pre>
<div class="sourceCode" id="cb207"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> angle_to_north_pole(v, axis<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.arccos((north_pole <span class="op">*</span> v).<span class="bu">sum</span>(axis<span class="op">=</span>axis))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Check some basic examples</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>angle_to_north_pole(np.array((<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.0</code></pre>
<div class="sourceCode" id="cb210"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>angle_to_north_pole(np.array((<span class="dv">0</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>3.141592653589793</code></pre>
<div class="sourceCode" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>angle_to_north_pole(np.array((<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.5707963267948966</code></pre>
<div class="sourceCode" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>angle_to_north_pole(np.array((<span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>),<span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>),<span class="dv">0</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.5707963267948966</code></pre>
<div class="sourceCode" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>angle_to_north_pole(np.array((<span class="dv">0</span>, <span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>),<span class="dv">1</span><span class="op">/</span>sqrt(<span class="dv">2</span>))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.7853981633974484</code></pre>
<p>Lets check the rotation in action</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> random_sphere_point(<span class="dv">1</span>)[:,<span class="dv">0</span>]</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.29445315, -0.46089653, -0.83718082])</code></pre>
<div class="sourceCode" id="cb220"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> angle_to_north_pole(p)</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a>axis <span class="op">=</span> perp_to_north_pole(p)</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>axis, theta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-0.84270333,  0.53837821,  0.        ]), 2.562904446655308)</code></pre>
<p>Check that it’s perpendicular and of unit norm</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a>(axis <span class="op">*</span> north_pole).<span class="bu">sum</span>(), (axis <span class="op">*</span> p).<span class="bu">sum</span>(), (axis <span class="op">*</span> axis).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.0, 0.0, 1.0)</code></pre>
<div class="sourceCode" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a>R <span class="op">=</span> rot_matrix(axis, <span class="op">-</span>theta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And indeed it rotates to the north pole</p>
<div class="sourceCode" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>distance(R <span class="op">@</span> p , north_pole)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>1.0938523993656688</code></pre>
</section>
</section>
<section id="exponential-map-at-any-point" class="level2">
<h2 class="anchored" data-anchor-id="exponential-map-at-any-point">Exponential map at any point</h2>
<p>Now we can take the exponential map at any point by first rotating to the north pole, calculating the exponential map, and then rotating back.</p>
<p>Let’s take some point on the sphere</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> random_sphere_point(<span class="dv">1</span>)[:,<span class="dv">0</span>]</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.52085469, -0.70958405,  0.47455333])</code></pre>
<p>And a random point on its tangent plane (not too far from the origin)</p>
<div class="sourceCode" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>max_dist <span class="op">=</span> pi</span>
<span id="cb229-2"><a href="#cb229-2" aria-hidden="true" tabindex="-1"></a>length <span class="op">=</span> np.random.random(<span class="dv">1</span>) <span class="op">*</span> max_dist</span>
<span id="cb229-3"><a href="#cb229-3" aria-hidden="true" tabindex="-1"></a>direction <span class="op">=</span> np.random.random(<span class="dv">1</span>) <span class="op">*</span> <span class="dv">2</span> <span class="op">*</span> np.pi</span>
<span id="cb229-4"><a href="#cb229-4" aria-hidden="true" tabindex="-1"></a>tx, ty <span class="op">=</span> length <span class="op">*</span> cos(direction), length <span class="op">*</span> sin(direction)</span>
<span id="cb229-5"><a href="#cb229-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb229-6"><a href="#cb229-6" aria-hidden="true" tabindex="-1"></a>tx, ty</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-1.23956389]), array([1.68843737]))</code></pre>
<p>Let’s rotate it to the north pole</p>
<div class="sourceCode" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a>theta <span class="op">=</span> angle_to_north_pole(p)</span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>axis <span class="op">=</span> perp_to_north_pole(p)</span>
<span id="cb231-3"><a href="#cb231-3" aria-hidden="true" tabindex="-1"></a>axis, theta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-0.80613779,  0.59172786,  0.        ]), 1.076339808354696)</code></pre>
<div class="sourceCode" id="cb233"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>rot_matrix(axis, theta) <span class="op">@</span> p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([8.32667268e-17, 0.00000000e+00, 1.00000000e+00])</code></pre>
<p>The tangent plane doesn’t change it’s coordinatisation, so we can just calculate the exponential map.</p>
<div class="sourceCode" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>q_rot <span class="op">=</span> exp_northpole(tx, ty)</span>
<span id="cb235-2"><a href="#cb235-2" aria-hidden="true" tabindex="-1"></a>q_rot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-0.51244602]), array([0.69801406]), array([-0.50017542]))</code></pre>
<p>The distance is preserved by the exponential map</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a>geodist(np.array([<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>]), np.array(q_rot)), np.sqrt(tx<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> ty<span class="op">**</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([2.09459767]), array([2.09459767]))</code></pre>
<p>And now we need to rotate the sphere back</p>
<div class="sourceCode" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> rot_matrix(axis, <span class="op">-</span>theta) <span class="op">@</span> q_rot</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[-0.33260114],
       [ 0.94302493],
       [-0.00897019]])</code></pre>
<p>And we check the distances are preserved</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>geodist(p, q), np.sqrt(tx<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> ty<span class="op">**</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([2.09459767]), array([2.09459767]))</code></pre>
<p>Putting this all together we get a function that calculates the expoential map at point p on the sphere, for vector t in its tangent space.</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> exp(p, t):</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>    tx, ty <span class="op">=</span> t</span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> angle_to_north_pole(p)</span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>    axis <span class="op">=</span> perp_to_north_pole(p)</span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-6"><a href="#cb243-6" aria-hidden="true" tabindex="-1"></a>    q_rot <span class="op">=</span> exp_northpole(tx, ty)</span>
<span id="cb243-7"><a href="#cb243-7" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> rot_matrix(axis, <span class="op">-</span>theta) <span class="op">@</span> q_rot</span>
<span id="cb243-8"><a href="#cb243-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> exp(p, (tx, ty))</span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[-0.33260114],
       [ 0.94302493],
       [-0.00897019]])</code></pre>
<div class="sourceCode" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>geodist(p, q), sqrt(tx<span class="op">*</span>tx <span class="op">+</span> ty<span class="op">*</span>ty)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([2.09459767]), array([2.09459767]))</code></pre>
<section id="inverse-expoenential-map-at-any-point" class="level3">
<h3 class="anchored" data-anchor-id="inverse-expoenential-map-at-any-point">Inverse expoenential map at any point</h3>
<p>The logic is essentially the same for the inverse map, which we call log, except we perform the rotation <em>before</em> we apply the map.</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log(p, q):</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>    theta <span class="op">=</span> angle_to_north_pole(p)</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    axis <span class="op">=</span> perp_to_north_pole(p)</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>    q_rot <span class="op">=</span> rot_matrix(axis, theta) <span class="op">@</span> q</span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> log_northpole(<span class="op">*</span>q_rot)</span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So at any point p the log should be the inverse of exp</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.array([tx,ty])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb250"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>t, log(p, exp(p, t))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([[-1.23956389],
        [ 1.68843737]]),
 (array([-1.23956389]), array([1.68843737])))</code></pre>
<div class="sourceCode" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> random_sphere_point(<span class="dv">1</span>)[:,<span class="dv">0</span>]</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.21868918, 0.77422052, 0.59393403])</code></pre>
<div class="sourceCode" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>exp(p, log(p, q))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.21868918, 0.77422052, 0.59393403])</code></pre>
</section>
</section>
</section>
<section id="attempting-to-implement-algorithm-a1" class="level1">
<h1>Attempting to Implement Algorithm A1</h1>
<p>We finally have all the pieces we need to implement algorithm A1 on page 23 of the paper, at least for the special case d=2 and weights all equal to 1/n.</p>
<pre><code>Algorithm A1:
Inputs: Points p1, ..., pn on S^d
        Non-negative weights w1, ..., wn with sum 1.
Output: The spherical weighted average of the inputs.
Initialization: Set q := sum(w * p) / norm(sum(w * p))
Main Loop:
For i = 1, ..., n
    Set p_i* := log(q, p_i)
Set u := sum(w_i * (p_i* - q), i=1..n)
Set q := exp(q, q + u).
If norm(u) is sufficiently small, output q and halt.
Otherwise continue looping.</code></pre>
<div class="sourceCode" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> random_sphere_point(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> average_projection(ps, axis<span class="op">=-</span><span class="dv">1</span>):</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>    avg <span class="op">=</span> ps.mean(axis<span class="op">=</span>axis)</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> norm(avg)</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> avg<span class="op">/</span>n</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> average_projection(ps)</span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>q</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.96262568,  0.25959003,  0.07723227])</code></pre>
<div class="sourceCode" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, q)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.94612087])</code></pre>
<div class="sourceCode" id="cb263"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a>p_tangent <span class="op">=</span> np.array(log(q, ps))</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a>p_tangent</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([[-0.95857123,  0.61845951, -0.00271409, -0.10243155],
       [ 1.59888405,  0.20774684, -0.09692084, -1.16640361]])</code></pre>
<p>Note in <code>u := sum( w_i * (p_i* - q))</code> the <code>q</code> is actually the projection of q into the tangent space, which is the origin. When the weights are equal this reduces to the mean.</p>
<p>So this reduces to <code>u := 1/n sum(p_i)</code></p>
<div class="sourceCode" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>u <span class="op">=</span> p_tangent.mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>u</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.11131434,  0.13582661])</code></pre>
<div class="sourceCode" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>q2 <span class="op">=</span> exp(q, u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb268"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, q2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.99423434])</code></pre>
<p>Let’s wrap this up in a function.</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> step_A1(q, ps):</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>    p_tangent <span class="op">=</span> np.array(log(q, ps))</span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> p_tangent.mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> exp(q, u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> alg_A1(ps, eps<span class="op">=</span><span class="fl">1e-5</span>, maxiter<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fixpoint(step_A1, average_projection(ps), ps<span class="op">=</span>ps, eps<span class="op">=</span>eps, maxiter<span class="op">=</span>maxiter)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>a1 <span class="op">=</span> alg_A1(ps)</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a>a1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.93352393,  0.3425671 , -0.10573959])</code></pre>
<div class="sourceCode" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, a1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([1.00335339])</code></pre>
<p>It has converged</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>p_tangent <span class="op">=</span> np.array(log(a1, ps))</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>p_tangent.mean(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-1.85819581e-06, -5.84658255e-07])</code></pre>
<p>Something is wrong; I can actually find a closer point with random search, or my previous implementation!</p>
<p>I’m not sure whether I implemented the algorithm incorrectly, or whether the algorithm itself is incorrect.</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, random_sphere_point(<span class="dv">10000</span>)).<span class="bu">min</span>(), avg_distance(ps, spherical_centroid(ps))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(0.9329403881785946, array([0.9276463]))</code></pre>
<section id="whats-going-on-here" class="level3">
<h3 class="anchored" data-anchor-id="whats-going-on-here">What’s going on here?</h3>
<section id="checking-the-code" class="level4">
<h4 class="anchored" data-anchor-id="checking-the-code">Checking the code</h4>
<p>Ideally I’d compare it with the results of their <a href="http://math.ucsd.edu/~sbuss/ResearchWeb/spheremean/">C++ code</a> but running gcc I get a bunch of errors that would take me some time to debug</p>
<pre><code>&gt; gcc SphereMean.cpp
In file included from SphereMean.h:32,
                 from SphereMean.cpp:28:
../VrMath/LinearR4.h:207:7: warning: extra qualification ‘Matrix4x4::’ on member ‘operator*=’ [-fpermissive]
  207 |  void Matrix4x4::operator*= (const Matrix4x4&amp; B); // Matrix product
      |       ^~~~~~~~~
SphereMean.cpp: In function ‘Quaternion ComputeMeanQuat(long int, const Quaternion*, const double*, double, double)’:
SphereMean.cpp:236:34: error: no matching function for call to ‘VectorR4::VectorR4(const Quaternion&amp;)’
  236 |   vvArray[i] = VectorR4( *(qq+i) );
      |                                  ^
In file included from SphereMean.h:32,
                 from SphereMean.cpp:28:
../VrMath/LinearR4.h:73:2: note: candidate: ‘VectorR4::VectorR4(double, double, double, double)’
   73 |  VectorR4( double xVal, double yVal, double zVal, double wVal )
      |  ^~~~~~~~
../VrMath/LinearR4.h:73:2: note:   candidate expects 4 arguments, 1 provided
../VrMath/LinearR4.h:72:2: note: candidate: ‘VectorR4::VectorR4()’
   72 |  VectorR4( ) : x(0.0), y(0.0), z(0.0), w(0.0) {}
      |  ^~~~~~~~
../VrMath/LinearR4.h:72:2: note:   candidate expects 0 arguments, 1 provided
../VrMath/LinearR4.h:55:7: note: candidate: ‘constexpr VectorR4::VectorR4(const VectorR4&amp;)’
   55 | class VectorR4 {
      |       ^~~~~~~~
../VrMath/LinearR4.h:55:7: note:   no known conversion for argument 1 from ‘const Quaternion’ to ‘const VectorR4&amp;’
../VrMath/LinearR4.h:55:7: note: candidate: ‘constexpr VectorR4::VectorR4(VectorR4&amp;&amp;)’
../VrMath/LinearR4.h:55:7: note:   no known conversion for argument 1 from ‘const Quaternion’ to ‘VectorR4&amp;&amp;’
</code></pre>
</section>
<section id="checking-the-proof" class="level4">
<h4 class="anchored" data-anchor-id="checking-the-proof">Checking the proof</h4>
<p>They claim that in Theorem 3, that by Lemma 2a that a spherical centroid will be a centroid in the tangent space.</p>
<p>I’m having a lot of trouble following their proof because they change and introduce notation so quickly, but we can try to validate this claim.</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> spherical_centroid(ps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It doesn’t seem to be the case</p>
<div class="sourceCode" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>np.array(log(c, ps)).mean(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.14373332,  0.20639589])</code></pre>
<p>However it does preserve distances, so it seems likely to be the correct exponential map</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>np.sqrt((np.array(log(c, ps)) <span class="op">*</span> np.array(log(c, ps))).<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>)).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>0.9276463013575129</code></pre>
<div class="sourceCode" id="cb286"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.9276463])</code></pre>
<div class="sourceCode" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>np.array(log(c, ps)).mean(axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([-0.14373332,  0.20639589])</code></pre>
<div class="sourceCode" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a>avg_distance(ps, c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>array([0.9276463])</code></pre>
</section>
</section>
<section id="outline-of-a-method-of-checking" class="level2">
<h2 class="anchored" data-anchor-id="outline-of-a-method-of-checking">Outline of a method of checking</h2>
<p>I think there’s a way we could check this, but I have not taken the time to implement it.</p>
<p>The stereographic projection about any point, and it’s inverse, are straightforward to implement with standard geometry of points, lines and spheres. Some geometry shows that the stereographic projection of a circle maps the angle t to a point 2 tan(t/2). So it follows that composing the stereographic projection by a function f(x) = 2 arctan(x/2) should give the exponential map.</p>
<p>We would check this gives the same results as above.</p>
<p>Using Pytorch we could start with latitude and longitude (as below) and project to cartesian coordinates and apply the inverse exponential map to get to the tangent plane. Then we could check the formulas of lemma 2a.</p>
</section>
</section>
<section id="part-3-gradient-descent-with-pytorch-1" class="level1">
<h1>Part 3: Gradient Descent With Pytorch</h1>
<section id="gradient-descent" class="level2">
<h2 class="anchored" data-anchor-id="gradient-descent">Gradient Descent</h2>
<p>At the end of the day the paper’s approach was just a form of gradient descent (which I couldn’t get working). But we can get an autograd library, like that in Pytorch, to calculate the gradients for us. The only trick here is we need to choose sphere coordinates (otherwise it will tell us to go off the sphere, unless we use Lagrange multipliers).</p>
<div class="sourceCode" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> torch_latlon_geodist(lat1, lon1, lat2, lon2):</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>  torch.arccos(torch.sin(lat1) <span class="op">*</span> torch.sin(lat2) <span class="op">+</span> torch.cos(lat1) <span class="op">*</span> torch.cos(lat2) <span class="op">*</span> torch.cos(lon2 <span class="op">-</span> lon1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>latlon_ps <span class="op">=</span> torch.tensor(coord_to_latlon(<span class="op">*</span>ps))</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>latlon_ps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>tensor([[-0.7885,  0.6007,  0.0995,  0.1919],
        [ 0.9673,  2.4580,  2.9729, -2.2270]], dtype=torch.float64)</code></pre>
<div class="sourceCode" id="cb296"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> centroid_gradient_descent(c, ps, lr<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> torch_latlon_geodist(<span class="op">*</span>c, <span class="op">*</span>ps).mean()</span>
<span id="cb296-3"><a href="#cb296-3" aria-hidden="true" tabindex="-1"></a>    dist.backward()</span>
<span id="cb296-4"><a href="#cb296-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb296-5"><a href="#cb296-5" aria-hidden="true" tabindex="-1"></a>        c <span class="op">-=</span> lr <span class="op">*</span> c.grad</span>
<span id="cb296-6"><a href="#cb296-6" aria-hidden="true" tabindex="-1"></a>    c.grad.zero_()</span>
<span id="cb296-7"><a href="#cb296-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> c, dist.item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> centroid_sphere_gd(ps, eps<span class="op">=</span><span class="fl">1e-6</span>, max_iter<span class="op">=</span><span class="dv">1000</span>, lr<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> ps.mean(axis<span class="op">=</span><span class="dv">1</span>).requires_grad_()</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> <span class="va">None</span></span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(max_iter):</span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>        last_dist <span class="op">=</span> dist</span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>        c, dist <span class="op">=</span> centroid_gradient_descent(c, ps, lr<span class="op">=</span>lr)</span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> last_dist <span class="kw">and</span> <span class="bu">abs</span>(dist <span class="op">-</span> last_dist) <span class="op">&lt;</span> eps:</span>
<span id="cb297-8"><a href="#cb297-8" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> c.requires_grad_(<span class="va">False</span>)</span>
<span id="cb297-9"><a href="#cb297-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Did not converge"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Using torch gradient descent</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>c2 <span class="op">=</span> centroid_sphere_gd(latlon_ps)</span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>c2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>tensor([0.1012, 2.9704], dtype=torch.float64)</code></pre>
<div class="sourceCode" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a>c2c <span class="op">=</span> latlon_to_coord(<span class="op">*</span>np.array(c2))</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>c2c, avg_distance(ps, c2c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-0.98034083,  0.16950631,  0.1009924 ]), array([0.92810049]))</code></pre>
<div class="sourceCode" id="cb302"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>c2.requires_grad_()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>tensor([0.1012, 2.9704], dtype=torch.float64, requires_grad=True)</code></pre>
<div class="sourceCode" id="cb304"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> torch_latlon_geodist(<span class="op">*</span>c2, <span class="op">*</span>latlon_ps).mean()</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>dist.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>torch_latlon_geodist(<span class="op">*</span>latlon_ps, <span class="op">*</span>c2).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>tensor(0.9281, dtype=torch.float64, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
<p>Closely matches our original function</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> spherical_centroid(ps)</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>c, avg_distance(ps, c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<pre><code>(array([-0.98093006,  0.16703028,  0.09938358]), array([0.9276463]))</code></pre>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>